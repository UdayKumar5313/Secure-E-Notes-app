<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        .note-item.active {
            background-color: #0f172a; /* slate-900 */
            color: white;
            transform: scale(1.02);
            box-shadow: 0 4px 14px 0 rgb(0 0 0 / 10%);
        }
        .note-item.active .delete-btn {
            color: #cbd5e1; /* slate-300 */
        }
        .note-item.active .delete-btn:hover {
            color: white;
        }
        .prose {
             line-height: 1.7;
        }
        /* Custom scrollbar */
        #notesList::-webkit-scrollbar {
            width: 6px;
        }
        #notesList::-webkit-scrollbar-track {
            background: #e2e8f0; /* slate-200 */
            border-radius: 10px;
        }
        #notesList::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        #notesList::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-10 border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Secure E-Notes</h1>
                        <p class="text-sm text-slate-500">Your encrypted notes, safely stored</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="realTimeClock" class="text-sm text-slate-600 font-medium bg-slate-100 px-3 py-1.5 rounded-lg text-center w-full sm:w-auto"></div>
                        <button id="newNoteBtn" class="flex items-center justify-center gap-2 bg-slate-900 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-900 focus:ring-offset-2 transition-all duration-200 hover:shadow-lg w-full sm:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            New Note
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8">
                <!-- Left Column: Notes List -->
                <div class="md:col-span-1 lg:col-span-1 bg-white p-6 rounded-xl border border-slate-200 h-fit shadow-sm">
                    <h2 class="text-lg font-semibold mb-4">Your Notes</h2>
                    <div class="relative mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input id="searchInput" type="text" placeholder="Search notes..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 transition-shadow">
                    </div>
                    <div id="notesList" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Notes will be dynamically inserted here -->
                    </div>
                    <div id="noNotesMessage" class="text-center py-8 text-slate-500 hidden">
                        <p>No notes found. Create your first encrypted note!</p>
                    </div>
                </div>

                <!-- Right Column: Note View -->
                <div class="md:col-span-2 lg:col-span-3">
                    <div id="noteView" class="bg-white p-6 sm:p-8 rounded-xl border border-slate-200 min-h-[70vh] flex items-center justify-center transition-all duration-300 shadow-sm">
                        <div id="selectNotePlaceholder" class="text-center text-slate-500">
                            <div class="bg-slate-100 w-24 h-24 rounded-full mx-auto flex items-center justify-center mb-4 border-4 border-slate-200">
                               <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            </div>
                            <h3 class="text-xl font-semibold">Select a Note</h3>
                            <p>Choose a note from the list to view its encrypted content</p>
                        </div>

                        <div id="decryptionView" class="w-full max-w-lg hidden">
                            <!-- Decryption form will be shown here -->
                        </div>

                        <div id="contentView" class="w-full h-full hidden">
                             <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-200">
                                <h2 id="noteTitle" class="text-3xl font-bold"></h2>
                                <button id="editNoteBtn" class="flex items-center gap-2 text-sm font-semibold text-slate-600 hover:text-slate-900 transition-colors bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    Edit Note
                                </button>
                            </div>
                            <div id="noteContent" class="prose max-w-none text-slate-700 whitespace-pre-wrap mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="fixed bottom-4 right-4 z-20">
            <a href="https://www.linkedin.com/in/uday-kumar-cybersecurity?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" rel="noopener noreferrer" class="bg-slate-800 text-white text-sm font-semibold px-4 py-2 rounded-full shadow-lg hover:bg-slate-900 transition-all flex items-center gap-2 hover:shadow-xl hover:scale-105">
                UDAY KUMAR
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
        </footer>

        <!-- New/Edit Note Modal -->
        <div id="noteModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0">
                <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                    <div>
                        <h2 id="modalTitle" class="text-xl font-bold">Create New Note</h2>
                        <p id="modalSubtitle" class="text-sm text-slate-500">Your content will be encrypted before saving.</p>
                    </div>
                     <button id="closeModalBtn" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="noteTitleInput" class="block text-sm font-medium text-slate-700">Title</label>
                        <input type="text" id="noteTitleInput" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-slate-900 focus:border-slate-900 sm:text-sm transition-shadow">
                    </div>
                    <div>
                        <label for="noteContentInput" class="block text-sm font-medium text-slate-700">Content</label>
                        <textarea id="noteContentInput" rows="5" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-slate-900 focus:border-slate-900 sm:text-sm transition-shadow"></textarea>
                    </div>
                    <div>
                        <label for="notePasswordInput" class="block text-sm font-medium text-slate-700">Encryption Password</label>
                        <input type="password" id="notePasswordInput" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-slate-900 focus:border-slate-900 sm:text-sm transition-shadow" placeholder="Enter password to save">
                    </div>
                </div>
                <div class="bg-slate-50 p-6 flex justify-end items-center gap-4 rounded-b-xl">
                    <button id="cancelModalBtn" class="px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-200 transition-colors">Cancel</button>
                    <button id="saveNoteBtn" class="flex items-center gap-2 bg-slate-900 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-900 focus:ring-offset-2 transition-colors">
                        <svg id="saveBtnIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span id="saveBtnText">Create & Encrypt</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300 scale-95 opacity-0">
                <div class="p-6 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">Delete Note</h3>
                    <div class="mt-2 text-sm text-gray-500">
                        <p>Are you sure you want to delete this note? This action cannot be undone.</p>
                    </div>
                </div>
                <div class="bg-slate-50 px-6 py-4 flex justify-center gap-4 rounded-b-xl">
                    <button id="cancelDeleteBtn" type="button" class="px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-200 transition-colors">Cancel</button>
                    <button id="confirmDeleteBtn" type="button" class="inline-flex justify-center rounded-lg border border-transparent bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- Info Modal for errors and successes -->
        <div id="infoModal" class="fixed top-5 right-5 z-50 shadow-lg rounded-lg p-4 max-w-sm hidden transform transition-transform duration-300 ease-in-out translate-x-full">
            <p id="infoModalText" class="text-sm font-medium"></p>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const MAX_ATTEMPTS = 5;

        const appState = {
            notes: [],
            filteredNotes: [],
            selectedNoteId: null,
            editingNoteId: null,
            noteToDeleteId: null,
            decryptedContentCache: null,
            userId: null,
            db: null,
            auth: null,
            isAuthReady: false,
        };

        // DOM Elements
        const newNoteBtn = document.getElementById('newNoteBtn');
        const noteModal = document.getElementById('noteModal');
        const noteModalContent = noteModal.querySelector('div');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const notesList = document.getElementById('notesList');
        const noNotesMessage = document.getElementById('noNotesMessage');
        const searchInput = document.getElementById('searchInput');
        const realTimeClock = document.getElementById('realTimeClock');

        const selectNotePlaceholder = document.getElementById('selectNotePlaceholder');
        const decryptionView = document.getElementById('decryptionView');
        const contentView = document.getElementById('contentView');
        const noteTitleElem = document.getElementById('noteTitle');
        const noteContentElem = document.getElementById('noteContent');
        const editNoteBtn = document.getElementById('editNoteBtn');

        const infoModal = document.getElementById('infoModal');
        const infoModalText = document.getElementById('infoModalText');
        
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalContent = deleteModal.querySelector('div');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');


        // --- UI Functions ---

        const showInfoModal = (message, type = 'success') => {
            infoModalText.textContent = message;
            infoModal.classList.remove('hidden', 'translate-x-full', 'bg-green-100', 'bg-red-100', 'bg-yellow-100');
            infoModalText.classList.remove('text-green-700', 'text-red-700', 'text-yellow-700');
            
            if(type === 'error') {
                infoModal.classList.add('bg-red-100');
                infoModalText.classList.add('text-red-700');
            } else if (type === 'warning') {
                infoModal.classList.add('bg-yellow-100');
                infoModalText.classList.add('text-yellow-700');
            } else {
                infoModal.classList.add('bg-green-100');
                infoModalText.classList.add('text-green-700');
            }

            setTimeout(() => {
                infoModal.classList.remove('translate-x-full');
                infoModal.classList.add('translate-x-0');
            }, 10);
            
            setTimeout(() => {
                infoModal.classList.remove('translate-x-0');
                infoModal.classList.add('translate-x-full');
                 setTimeout(() => {
                     infoModal.classList.add('hidden');
                 }, 300);
            }, 4000);
        };
        
        const renderNotesList = () => {
            notesList.innerHTML = '';
            const notesToRender = appState.filteredNotes;

            if (appState.notes.length === 0) {
                noNotesMessage.classList.remove('hidden');
            } else {
                noNotesMessage.classList.add('hidden');
            }
            
            notesToRender.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = `note-item p-3 rounded-lg cursor-pointer transition-all duration-200 flex justify-between items-center`;
                noteEl.dataset.id = note.id;

                const titleSpan = document.createElement('span');
                titleSpan.textContent = note.title;
                titleSpan.className = 'truncate flex-grow';
                titleSpan.onclick = () => handleNoteSelect(note.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn text-slate-400 hover:text-red-600 transition-colors p-1 rounded-full flex-shrink-0';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    handleDeleteRequest(note.id);
                };

                noteEl.appendChild(titleSpan);
                noteEl.appendChild(deleteBtn);

                if(appState.selectedNoteId === note.id) noteEl.classList.add('active');
                
                notesList.appendChild(noteEl);
            });
        };

        const renderNoteView = () => {
            const selectedNote = appState.notes.find(n => n.id === appState.selectedNoteId);

            if (!selectedNote) {
                selectNotePlaceholder.classList.remove('hidden');
                decryptionView.classList.add('hidden');
                contentView.classList.add('hidden');
                appState.decryptedContentCache = null;
                return;
            }

            selectNotePlaceholder.classList.add('hidden');
            decryptionView.classList.remove('hidden');
            contentView.classList.add('hidden');
            
            const attempts = selectedNote.failedAttempts || 0;
            const attemptsRemaining = MAX_ATTEMPTS - attempts;

            decryptionView.innerHTML = `
                <h3 class="text-2xl font-semibold text-center mb-2">Unlock Note</h3>
                <p class="text-center text-slate-500 mb-6">Enter the password for "${selectedNote.title}" to decrypt its content.</p>
                <div class="space-y-4">
                     <div>
                        <label for="decryptPassword" class="block text-sm font-medium text-slate-700">Decryption Password</label>
                        <input type="password" id="decryptPassword" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-slate-900 focus:border-slate-900 sm:text-sm transition-shadow">
                    </div>
                    <div id="attemptsWarning" class="text-center text-sm font-medium ${attempts > 0 ? 'text-yellow-600' : 'text-slate-400'}">
                        ${attemptsRemaining} of ${MAX_ATTEMPTS} attempts remaining.
                    </div>
                    <button id="decryptBtn" class="w-full flex justify-center items-center gap-2 bg-slate-900 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-900 focus:ring-offset-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 5-5v0a5 5 0 0 1 5 5v4"></path></svg>
                        Decrypt
                    </button>
                </div>
            `;
            document.getElementById('decryptBtn').addEventListener('click', handleDecrypt);
            document.getElementById('decryptPassword').focus();
            document.getElementById('decryptPassword').addEventListener('keyup', (e) => {
                if(e.key === 'Enter') handleDecrypt();
            });
        };
        
        const showDecryptedContent = (title, content) => {
            decryptionView.classList.add('hidden');
            contentView.classList.remove('hidden');
            noteTitleElem.textContent = title;
            noteContentElem.textContent = content;
            appState.decryptedContentCache = content;
        }

        // --- Event Handlers & Logic ---
        
        const handleNoteSelect = (id) => {
            if (appState.selectedNoteId === id) return;
            appState.selectedNoteId = id;
            appState.decryptedContentCache = null;
            renderNotesList();
            renderNoteView();
        };

        const handleFilterNotes = () => {
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                appState.filteredNotes = appState.notes.filter(note => note.title.toLowerCase().includes(searchTerm));
            } else {
                appState.filteredNotes = [...appState.notes];
            }
            renderNotesList();
        };

        const handleDecrypt = async () => {
            const password = document.getElementById('decryptPassword').value;
            const note = appState.notes.find(n => n.id === appState.selectedNoteId);
            const noteRef = doc(appState.db, `artifacts/${getAppId()}/users/${appState.userId}/notes`, note.id);

            if (!password) {
                showInfoModal('Please enter a password.', 'warning');
                return;
            }

            try {
                const decryptedBytes = CryptoJS.AES.decrypt(note.encryptedContent, password);
                const decryptedText = decryptedBytes.toString(CryptoJS.enc.Utf8);
                
                if (!decryptedText) throw new Error('Invalid password');
                
                showDecryptedContent(note.title, decryptedText);
                if (note.failedAttempts > 0) {
                    await updateDoc(noteRef, { failedAttempts: 0 });
                }

            } catch (error) {
                const currentAttempts = (note.failedAttempts || 0) + 1;
                
                if (currentAttempts >= MAX_ATTEMPTS) {
                    await deleteDoc(noteRef);
                    showInfoModal(`Note "${note.title}" deleted permanently.`, 'error');
                    appState.selectedNoteId = null;
                    renderNoteView();
                } else {
                    await updateDoc(noteRef, { failedAttempts: currentAttempts });
                    const attemptsRemaining = MAX_ATTEMPTS - currentAttempts;
                    showInfoModal(`Incorrect password. ${attemptsRemaining} attempts remaining.`, 'error');
                }
            }
        };

        const openNoteModal = (mode = 'create') => {
            const modalTitle = document.getElementById('modalTitle');
            const modalSubtitle = document.getElementById('modalSubtitle');
            const saveBtnText = document.getElementById('saveBtnText');
            
            if (mode === 'edit') {
                const note = appState.notes.find(n => n.id === appState.selectedNoteId);
                appState.editingNoteId = note.id;
                modalTitle.textContent = "Edit Note";
                modalSubtitle.textContent = "Your changes will be re-encrypted upon saving.";
                saveBtnText.textContent = "Save & Re-encrypt";
                document.getElementById('noteTitleInput').value = note.title;
                document.getElementById('noteContentInput').value = appState.decryptedContentCache;
            } else {
                appState.editingNoteId = null;
                modalTitle.textContent = "Create New Note";
                modalSubtitle.textContent = "Your content will be encrypted before saving.";
                saveBtnText.textContent = "Create & Encrypt";
                document.getElementById('noteTitleInput').value = '';
                document.getElementById('noteContentInput').value = '';
            }

            document.getElementById('notePasswordInput').value = '';
            
            noteModal.classList.remove('hidden');
            setTimeout(() => {
                noteModal.classList.add('opacity-100');
                noteModalContent.classList.remove('scale-95', 'opacity-0');
                document.getElementById('noteTitleInput').focus();
            }, 10);
        };

        const closeNoteModal = () => {
             noteModal.classList.remove('opacity-100');
             noteModalContent.classList.add('scale-95', 'opacity-0');
             setTimeout(() => {
                noteModal.classList.add('hidden');
             }, 300);
        };

        const handleSaveNote = async () => {
            const title = document.getElementById('noteTitleInput').value.trim();
            const content = document.getElementById('noteContentInput').value.trim();
            const password = document.getElementById('notePasswordInput').value;

            if (!title || !content || !password) {
                showInfoModal('All fields are required.', 'warning');
                return;
            }

            saveNoteBtn.disabled = true;
            saveNoteBtn.querySelector('#saveBtnText').textContent = 'Encrypting...';

            try {
                const encryptedContent = CryptoJS.AES.encrypt(content, password).toString();
                
                if (appState.editingNoteId) {
                    // Update existing note
                    const noteRef = doc(appState.db, `artifacts/${getAppId()}/users/${appState.userId}/notes`, appState.editingNoteId);
                    await updateDoc(noteRef, { title, encryptedContent });
                    showInfoModal('Note updated successfully!', 'success');
                    appState.selectedNoteId = null; // Deselect to force re-decryption
                    renderNoteView();
                } else {
                    // Create new note
                    const newNote = { title, encryptedContent, createdAt: new Date(), failedAttempts: 0 };
                    const notesCollectionRef = collection(appState.db, `artifacts/${getAppId()}/users/${appState.userId}/notes`);
                    await addDoc(notesCollectionRef, newNote);
                    showInfoModal('Note created successfully!', 'success');
                }
                
                closeNoteModal();
            } catch (error) {
                console.error("Error saving note:", error);
                showInfoModal('Failed to save note. Please try again.', 'error');
            } finally {
                saveNoteBtn.disabled = false;
                // Text will be reset when modal is next opened
            }
        };

        const handleDeleteRequest = (id) => {
            appState.noteToDeleteId = id;
            deleteModal.classList.remove('hidden');
            setTimeout(() => {
                deleteModal.classList.add('opacity-100');
                deleteModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        };
        
        const closeDeleteModal = () => {
            deleteModal.classList.remove('opacity-100');
            deleteModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                deleteModal.classList.add('hidden');
                appState.noteToDeleteId = null;
            }, 300);
        }

        const confirmDelete = async () => {
            if (!appState.noteToDeleteId) return;

            const noteRef = doc(appState.db, `artifacts/${getAppId()}/users/${appState.userId}/notes`, appState.noteToDeleteId);
            try {
                await deleteDoc(noteRef);
                showInfoModal("Note deleted successfully.", 'success');
                if (appState.selectedNoteId === appState.noteToDeleteId) {
                    appState.selectedNoteId = null;
                    renderNoteView();
                }
            } catch(e) {
                showInfoModal("Failed to delete note.", 'error');
                console.error("Delete error:", e);
            } finally {
                closeDeleteModal();
            }
        };

        const updateClock = () => {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            const timeString = now.toLocaleTimeString('en-US');
            realTimeClock.textContent = `${dateString}, ${timeString}`;
        };

        // --- Firebase Initialization ---
        const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const initializeFirebase = () => {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                appState.db = getFirestore(app);
                appState.auth = getAuth(app);
                setupAuthListener();
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showInfoModal("Could not connect to the database. Please refresh.", 'error');
            }
        };
        
        const setupAuthListener = () => {
            onAuthStateChanged(appState.auth, user => {
                if (user) {
                    appState.userId = user.uid;
                    appState.isAuthReady = true;
                    setupNotesListener();
                } else {
                    appState.isAuthReady = false;
                }
            });
        };

        const setupNotesListener = () => {
             if (!appState.isAuthReady) return;
             const notesCollectionRef = collection(appState.db, `artifacts/${getAppId()}/users/${appState.userId}/notes`);
             const q = query(notesCollectionRef);

             onSnapshot(q, (snapshot) => {
                 appState.notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 appState.notes.sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());
                 handleFilterNotes();
                 if (appState.selectedNoteId && !appState.notes.some(n => n.id === appState.selectedNoteId)) {
                    appState.selectedNoteId = null;
                    renderNoteView();
                 }
             }, (error) => {
                 console.error("Error fetching notes:", error);
                 showInfoModal("Could not fetch notes.", 'error');
             });
        };

        const signInUser = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(appState.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(appState.auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showInfoModal("Authentication failed. You may not be able to save notes.", 'error');
            }
        };

        // --- App Entry Point ---
        document.addEventListener('DOMContentLoaded', () => {
            newNoteBtn.addEventListener('click', () => openNoteModal('create'));
            closeModalBtn.addEventListener('click', closeNoteModal);
            cancelModalBtn.addEventListener('click', closeNoteModal);
            saveNoteBtn.addEventListener('click', handleSaveNote);
            editNoteBtn.addEventListener('click', () => openNoteModal('edit'));
            
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            confirmDeleteBtn.addEventListener('click', confirmDelete);

            searchInput.addEventListener('input', handleFilterNotes);
            
            updateClock();
            setInterval(updateClock, 1000);
            
            initializeFirebase();
            signInUser();
        });
    </script>
</body>
</html>

