<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-primary: #111827; 
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --accent-primary: #6d28d9; /* Deep Purple */
            --accent-secondary: #db2777; /* Fuchsia */
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
        }

        [data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --accent-primary: #7c3aed;
            --accent-secondary: #ec4899;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .theme-transition-overlay { position: fixed; inset: 0; z-index: 9999; pointer-events: none; clip-path: circle(0% at var(--x) var(--y)); transition: clip-path 1.2s cubic-bezier(0.65, 0, 0.35, 1); }
        .bg-dynamic-primary { background-color: var(--bg-primary); }
        .bg-dynamic-secondary { background-color: var(--bg-secondary); }
        .bg-dynamic-tertiary { background-color: var(--bg-tertiary); }
        .text-dynamic-primary { color: var(--text-primary); }
        .text-dynamic-secondary { color: var(--text-secondary); }
        .border-dynamic { border-color: var(--border-color); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 550px; transform: scale(0.95); transition: transform 0.3s ease; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .note-item.selected { background-color: var(--accent-primary) !important; color: white !important; }
        .note-item.pinned { border-left-color: #f59e0b !important; }
        
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); color: white; opacity: 0; transform: translateX(100%); transition: all 0.4s ease-in-out; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #059669; } .toast-error { background-color: #dc2626; } .toast-warning { background-color: #d97706; }

        #loader-overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 200; transition: opacity 0.3s ease; }
        .loader { width: 48px; height: 48px; border: 5px solid var(--text-primary); border-bottom-color: var(--accent-primary); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-spinner {
            width: 1.25rem; height: 1.25rem; border: 2px solid #fff;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        #password-strength-bar { height: 5px; width: 0%; border-radius: 5px; transition: width 0.3s ease, background-color 0.3s ease; }
        .strength-weak { background-color: #ef4444; } .strength-medium { background-color: #f59e0b; } .strength-strong { background-color: #10b981; }

        .color-swatch { width: 24px; height: 24px; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: var(--accent-secondary); transform: scale(1.1); }
        .note-tag { background-color: var(--bg-tertiary); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; }
        mark { background-color: #f59e0b; color: #111827; padding: 0 2px; border-radius: 2px; }

        /* Markdown Editor Styles */
        .editor-tabs button { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; }
        .editor-tabs button.active { border-bottom-color: var(--accent-primary); color: var(--accent-primary); }
        #note-content-editor { font-family: monospace; }
        #note-content-preview { min-height: 10rem; }
        #note-content-preview > *:first-child { margin-top: 0; }
        #note-content-preview > *:last-child { margin-bottom: 0; }

        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>

<body class="bg-dynamic-primary text-dynamic-primary">
    
    <div id="loader-overlay" style="display: none;"><div class="loader"></div></div>
    <div id="toast-container"></div>
    <div id="print-area" class="hidden"></div>
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-dynamic pb-6">
                <div>
                    <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-pink-500">Secure E-Notes</h1>
                    <p class="text-dynamic-secondary">Your encrypted notes, safely stored.</p>
                </div>
                 <div class="flex items-center gap-4 mt-4 md:mt-0">
                    <div id="date-time" class="text-lg font-semibold text-dynamic-secondary text-center md:text-right"></div>
                    <button id="audit-log-btn" class="p-2 rounded-full hover:bg-dynamic-tertiary transition" aria-label="Security Audit Log"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.944a11.955 11.955 0 019-2.611m3.076 2.611a11.955 11.955 0 019 2.611 12.02 12.02 0 00-3-14.962c-3.73-3.73-9.83-3.73-13.56 0" /></svg></button>
                    <button id="trash-btn" class="p-2 rounded-full hover:bg-dynamic-tertiary transition" aria-label="View Trash"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    <button id="backup-btn" class="p-2 rounded-full hover:bg-dynamic-tertiary transition" aria-label="Import/Export Notes"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7v4c0 2.21 3.582 4 8 4s8-1.79 8-4V7" /></svg></button>
                     <button id="theme-toggle" class="p-2 rounded-full hover:bg-dynamic-tertiary transition" aria-label="Toggle theme">
                         <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                         <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                     </button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <button id="new-note-btn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Create New Note
                    </button>
                    <div class="bg-dynamic-secondary p-6 rounded-2xl shadow-2xl flex-grow">
                        <h2 class="text-2xl font-semibold mb-4 text-dynamic-primary">Your Notes</h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="search-notes" placeholder="Search notes..." class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-dynamic-primary">
                            <select id="tag-filter" class="bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-dynamic-primary"><option value="">All Tags</option></select>
                        </div>
                        <div id="notes-list" class="space-y-3 h-96 overflow-y-auto pr-2"></div>
                        <p id="no-notes-msg" class="text-gray-500 text-center mt-8 hidden">No notes found.</p>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-dynamic-secondary p-8 rounded-2xl shadow-2xl flex flex-col items-center justify-center min-h-[30rem]">
                    <div id="note-content-display" class="w-full h-full hidden flex flex-col">
                        <div class="flex justify-between items-center mb-4 gap-4">
                            <h2 id="note-title-display" class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400 truncate"></h2>
                            <div class="flex gap-2 shrink-0">
                                <button id="print-note-btn" aria-label="Print Note" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h10a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg></button>
                                <button id="export-note-btn" aria-label="Export as .txt" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                                <button id="copy-note-btn" aria-label="Copy Content" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg></button>
                                
                                <!-- AI Tools Dropdown -->
                                <div class="relative inline-block text-left">
                                    <div>
                                        <button type="button" id="ai-tools-btn" aria-label="AI Tools" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center" aria-expanded="false" aria-haspopup="true">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                        </button>
                                    </div>
                                    <div id="ai-tools-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-dynamic-tertiary ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="ai-tools-btn">
                                        <div class="py-1" role="none">
                                            <button id="ai-summarize-btn" class="text-dynamic-primary block w-full text-left px-4 py-2 text-sm hover:bg-dynamic-primary" role="menuitem">Summarize Note</button>
                                            <button id="ai-proofread-btn" class="text-dynamic-primary block w-full text-left px-4 py-2 text-sm hover:bg-dynamic-primary" role="menuitem">Proofread & Correct</button>
                                            <button id="ai-assistant-btn" class="text-dynamic-primary block w-full text-left px-4 py-2 text-sm hover:bg-dynamic-primary" role="menuitem">AI Assistant...</button>
                                        </div>
                                    </div>
                                </div>

                                <button id="edit-note-btn" aria-label="Edit Note" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            </div>
                        </div>
                        <div id="note-body-display" class="text-dynamic-secondary prose prose-invert max-w-none bg-dynamic-primary p-6 rounded-lg flex-grow overflow-y-auto"></div>
                    </div>
                    <div id="select-note-placeholder" class="text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg><h3 class="text-2xl font-semibold">Select a Note</h3><p>Choose a note from the list to view its encrypted content.</p></div>
                </div>
            </main>
            <footer class="text-center text-gray-500 mt-8 pt-6 border-t border-dynamic">
                <p>Developed by <a href="https://www.linkedin.com/in/uday-kumar-cybersecurity?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" rel="noopener noreferrer" class="text-purple-400 hover:underline">Uday Kumar</a></p>
                <p id="user-id-display" class="text-xs mt-2 truncate"></p>
            </footer>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="app-lock-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary">
            <!-- Setup View -->
            <div id="master-password-setup">
                <h2 class="text-2xl font-bold mb-4">Welcome to Secure E-Notes</h2>
                <p class="text-dynamic-secondary mb-6">To secure your application, please create a master password. This will be required every time you open the app.</p>
                <form id="master-password-setup-form">
                    <input type="password" id="master-password-create" placeholder="Create Master Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required>
                    <input type="password" id="master-password-confirm" placeholder="Confirm Master Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required>
                    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg">Set Password & Secure App</button>
                </form>
            </div>
            <!-- Login View -->
            <div id="master-password-login" class="hidden">
                 <h2 class="text-2xl font-bold mb-4">Enter Master Password</h2>
                <p class="text-dynamic-secondary mb-6">Enter your master password to unlock your notes.</p>
                <form id="master-password-login-form">
                    <input type="password" id="master-password-input" placeholder="Master Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required>
                    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg">Unlock</button>
                </form>
            </div>
        </div>
    </div>


    <div id="note-form-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary">
            <h2 id="note-form-title" class="text-2xl font-bold mb-6"></h2>
            <form id="note-form">
                <input type="hidden" id="note-id">
                <div class="mb-4">
                    <label for="note-title" class="block mb-2 font-semibold">Title</label>
                    <input type="text" id="note-title" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-4">
                    <div class="editor-tabs flex border-b border-dynamic mb-2"><button type="button" id="editor-tab-edit" class="active">Edit</button><button type="button" id="editor-tab-preview">Preview</button></div>
                    <textarea id="note-content-editor" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 h-40"></textarea>
                    <div id="note-content-preview" class="hidden p-4 prose prose-invert max-w-none bg-dynamic-tertiary rounded-lg h-40 overflow-y-auto"></div>
                    <div id="editor-char-count" class="text-xs text-right text-dynamic-secondary mt-1"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label for="note-tags" class="block mb-2 font-semibold">Tags (comma-separated)</label><input type="text" id="note-tags" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4"></div>
                    <div><label class="block mb-2 font-semibold">Color</label><div id="color-palette" class="flex gap-2 items-center"></div></div>
                </div>
                <div class="mb-2"><label for="note-password" class="block mb-2 font-semibold">Encryption Password</label><input type="password" id="note-password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4" required placeholder="Enter password to save"></div>
                <div class="mb-6"><div class="bg-gray-700 rounded-lg overflow-hidden"><div id="password-strength-bar"></div></div></div>
                <div class="flex justify-end gap-4"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" id="note-submit-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center min-w-[120px]"></button></div>
            </form>
        </div>
    </div>
    
    <div id="decrypt-note-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary"><h2 class="text-2xl font-bold mb-2">Enter Password</h2><p id="decrypt-note-title" class="text-dynamic-secondary mb-4"></p><p id="attempts-warning" class="text-red-500 text-sm mb-4 h-5 font-semibold"></p><form id="decrypt-note-form"><input type="hidden" id="decrypt-note-id"><input type="password" id="decrypt-password" placeholder="Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required><div class="flex justify-end gap-4"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg min-w-[100px]">Decrypt</button></div></form></div>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary">
            <h2 class="text-2xl font-bold mb-2">Confirm Permanent Deletion</h2>
            <p id="delete-confirm-text" class="text-dynamic-secondary mb-4"></p>
            <p class="text-sm text-red-500 mb-4">This action is irreversible.</p>
            <form id="delete-confirm-form">
                <input type="hidden" id="delete-confirm-note-id">
                <div class="mb-4">
                    <label for="delete-confirm-title-input" class="block mb-1 font-semibold text-sm">To confirm, type the note's title:</label>
                    <input type="text" id="delete-confirm-title-input" placeholder="Note Title" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4" required>
                </div>
                <div class="mb-4">
                     <label for="delete-confirm-password" class="block mb-1 font-semibold text-sm">Enter the note's password:</label>
                    <input type="password" id="delete-confirm-password" placeholder="Note Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg min-w-[180px]">Delete Permanently</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="session-warning-modal" class="modal-overlay">
        <div class="modal-content text-center bg-dynamic-secondary text-dynamic-primary">
            <h2 class="text-2xl font-bold mb-4">Session Timeout Warning</h2>
            <p class="mb-6 text-lg text-dynamic-secondary">For your security, the current note will be locked due to inactivity in <span id="session-countdown" class="font-bold">30</span> seconds. Do you want to continue working?</p>
            <div class="flex justify-center gap-4">
                <button id="session-lock-now-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Lock Now</button>
                <button id="session-extend-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Keep Working</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content text-center bg-dynamic-secondary text-dynamic-primary"><h2 id="confirm-title" class="text-2xl font-bold mb-4">Are you sure?</h2><p id="confirm-message" class="mb-6 text-lg text-dynamic-secondary"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button><button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Delete</button></div></div>
    </div>

    <div id="backup-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary"><h2 class="text-2xl font-bold mb-6">Backup & Restore</h2><div class="mb-6 border-b border-dynamic pb-6"><h3 class="font-semibold mb-2">Export Notes</h3><p class="text-sm text-dynamic-secondary mb-4">Create an encrypted backup of all your notes. Keep this password safe.</p><form id="export-form"><input type="password" id="export-password" placeholder="Backup Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Export Encrypted File</button></form></div><div><h3 class="font-semibold mb-2">Import Notes</h3><p class="text-sm text-dynamic-secondary mb-4">Restore notes from an encrypted backup file. This will overwrite notes with the same creation date.</p><form id="import-form"><input type="file" id="import-file" accept=".json" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 mb-4" required><input type="password" id="import-password" placeholder="Backup Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Import Notes</button></form></div></div>
    </div>

    <div id="trash-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary w-full max-w-2xl"><h2 class="text-2xl font-bold mb-4">Trash</h2><p class="text-sm text-dynamic-secondary mb-4">Notes in trash will be permanently deleted after 30 days.</p><div id="trash-list" class="space-y-3 h-96 overflow-y-auto pr-2"></div><p id="no-trash-msg" class="text-gray-500 text-center mt-8 hidden">Trash is empty.</p></div>
    </div>

    <div id="audit-log-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary w-full max-w-3xl">
            <h2 class="text-2xl font-bold mb-4">Security Audit Log</h2>
            <p class="text-sm text-dynamic-secondary mb-4">This log shows recent security-related activities in your account.</p>
            <div id="audit-log-list" class="space-y-3 h-96 overflow-y-auto pr-2 border border-dynamic rounded-lg p-4 bg-dynamic-primary"></div>
            <div class="flex justify-end mt-6">
                 <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>
    
    <div id="ai-assistant-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary">
            <h2 class="text-2xl font-bold mb-4">AI Assistant</h2>
            <p class="text-sm text-dynamic-secondary mb-4">Enter a prompt to generate content. The result will be appended to your current note.</p>
            <form id="ai-assistant-form">
                <textarea id="ai-prompt-input" placeholder="e.g., Write a short story about a space explorer" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 h-24 mb-4" required></textarea>
                <div class="flex justify-end gap-4">
                    <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="ai-generate-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg min-w-[120px]">Generate</button>
                </div>
            </form>
        </div>
    </div>

    <div id="ai-result-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary">
            <h2 id="ai-result-title" class="text-2xl font-bold mb-4">AI Result</h2>
            <div id="ai-result-content" class="prose prose-invert max-w-none bg-dynamic-tertiary rounded-lg h-64 overflow-y-auto p-4 mb-6"></div>
            <div class="flex justify-end gap-4">
                <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, getDocs, writeBatch, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Config & State ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; 
        let notesUnsubscribe = null; 
        let trashUnsubscribe = null;
        let auditLogUnsubscribe = null;
        let currentNotes = []; 
        let trashedNotes = [];
        let selectedNoteId = null; 
        let selectedColor = null;
        let decryptedCache = new Map(); // Store decrypted content for the session
        const MAX_ATTEMPTS = 5; 
        let autoLockTimer = null; let sessionWarningTimer = null; let sessionCountdownInterval = null;
        const AUTO_LOCK_TIME = 5 * 60 * 1000; // 5 minutes
        const SESSION_WARNING_TIME = 30 * 1000; // 30 seconds before lock
        const NOTE_COLORS = ['#34d399', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899'];
        const MASTER_PASS_CONFIG = { saltKey: 'masterPassSalt', checkKey: 'masterPassCheck' };

        // --- DOM Element Cache ---
        const el = (id) => document.getElementById(id);
        const loaderOverlay = el('loader-overlay'); 
        const newNoteBtn = el('new-note-btn'), notesListEl = el('notes-list'), noNotesMsg = el('no-notes-msg');
        const searchNotesInput = el('search-notes'), noteContentDisplay = el('note-content-display'), selectNotePlaceholder = el('select-note-placeholder');
        const noteTitleDisplay = el('note-title-display'), noteBodyDisplay = el('note-body-display'), themeToggleBtn = el('theme-toggle');
        const noteFormModal = el('note-form-modal'), decryptNoteModal = el('decrypt-note-modal'), confirmModal = el('confirm-modal');
        const noteForm = el('note-form'), decryptNoteForm = el('decrypt-note-form'), editNoteBtn = el('edit-note-btn'), copyNoteBtn = el('copy-note-btn');
        const exportNoteBtn = el('export-note-btn'), printNoteBtn = el('print-note-btn'), passwordInput = el('note-password');
        const strengthBar = el('password-strength-bar'), noteContentEditor = el('note-content-editor'), noteTitleInput = el('note-title');
        const tagFilter = el('tag-filter'), noteTagsInput = el('note-tags'), colorPalette = el('color-palette');
        const editorCharCount = el('editor-char-count'); const backupBtn = el('backup-btn'); const backupModal = el('backup-modal');
        const deleteConfirmModal = el('delete-confirm-modal'); const deleteConfirmForm = el('delete-confirm-form');
        const confirmOkBtn = el('confirm-ok-btn');
        const editorTabEdit = el('editor-tab-edit'), editorTabPreview = el('editor-tab-preview'), noteContentPreview = el('note-content-preview');
        const trashBtn = el('trash-btn'), trashModal = el('trash-modal');
        const auditLogBtn = el('audit-log-btn'), auditLogModal = el('audit-log-modal');
        const aiToolsBtn = el('ai-tools-btn'), aiToolsDropdown = el('ai-tools-dropdown');
        const aiSummarizeBtn = el('ai-summarize-btn'), aiProofreadBtn = el('ai-proofread-btn'), aiAssistantBtn = el('ai-assistant-btn');
        const aiAssistantModal = el('ai-assistant-modal'), aiAssistantForm = el('ai-assistant-form');
        const aiResultModal = el('ai-result-modal');
        const appLockModal = el('app-lock-modal');
        const masterPasswordSetupForm = el('master-password-setup-form');
        const masterPasswordLoginForm = el('master-password-login-form');
        const sessionWarningModal = el('session-warning-modal');

        // --- Utility Functions ---
        const showLoader = () => loaderOverlay.style.display = 'flex';
        const hideLoader = () => loaderOverlay.style.display = 'none';
        const showToast = (type, message) => { const toast = document.createElement('div'); toast.className = `toast toast-${type}`; toast.textContent = message; el('toast-container').appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 5000); };
        const encrypt = (text, password) => CryptoJS.AES.encrypt(text, password).toString();
        const decrypt = (ciphertext, password) => { const bytes = CryptoJS.AES.decrypt(ciphertext, password); const decryptedText = bytes.toString(CryptoJS.enc.Utf8); if (!decryptedText) throw new Error("Decryption failed"); return decryptedText; };
        
        const setButtonLoading = (button, isLoading, originalText = '') => {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = `<span class="btn-spinner"></span>`;
            } else {
                button.disabled = false;
                button.innerHTML = originalText || button.dataset.originalText || 'Submit';
            }
        };

        const closeModal = (modal) => modal.classList.remove('active');
        const openModal = (modalToOpen) => {
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                if (modal !== modalToOpen) closeModal(modal);
            });
            modalToOpen.classList.add('active');
        };
        const cancelBtnHandler = (btn) => { const modal = btn.closest('.modal-overlay'); if (modal === noteFormModal) { clearDraft(); } closeModal(modal); };
        
        // --- Gemini API Integration ---
        const callGemini = async (prompt, retries = 3, delay = 1000) => {
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = { contents: [{ parts: [{ text: prompt }] }], };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) { await new Promise(res => setTimeout(res, delay)); return callGemini(prompt, retries - 1, delay * 2); }
                    throw new Error(`API error: ${response.statusText}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) { return candidate.content.parts[0].text; } 
                else { throw new Error("Invalid response structure from API."); }
            } catch (error) {
                if (retries > 0) { await new Promise(res => setTimeout(res, delay)); return callGemini(prompt, retries - 1, delay * 2); }
                console.error("Error calling Gemini API:", error);
                throw error;
            }
        };

        // --- Core Application Logic ---
        const logActivity = async (action, details = {}) => {
            if (!currentUser) return;
            try {
                const logData = {
                    action,
                    details,
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent.substring(0, 150), // Limit user agent length
                };
                const logsCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'audit_logs');
                await addDoc(logsCollection, logData);
            } catch (error) {
                console.error("Failed to log activity:", error);
            }
        };
        
        async function completeLogin() {
            onAuthStateChanged(auth, user => { 
                if (user) { 
                    currentUser = user; 
                    el('user-id-display').textContent = `User ID: ${user.uid}`; 
                    loadNotes(); 
                    loadTrash(); 
                    loadAuditLogs();
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                else { await signInAnonymously(auth); }
            } catch (error) {
                console.error("Authentication failed:", error);
                showToast('error', 'Could not authenticate session.');
                hideLoader();
            }
        }

        function loadNotes() { 
            if (!currentUser) return; 

            // --- Optimization: Show immediate loading state in the notes panel ---
            notesListEl.innerHTML = `
                <div class="flex justify-center items-center h-full p-8">
                    <div class="w-6 h-6 border-4 border-dashed rounded-full animate-spin border-purple-500"></div>
                </div>
            `;
            noNotesMsg.classList.add('hidden');

            const notesCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notes'); 
            if (notesUnsubscribe) notesUnsubscribe(); 
            notesUnsubscribe = onSnapshot(notesCollection, (snapshot) => { 
                const newNotes = snapshot.docs.map(doc => {
                    const noteData = { id: doc.id, ...doc.data() };
                    const cached = decryptedCache.get(noteData.id);
                    if (cached) {
                        noteData.decryptedTitleCache = cached.title;
                        noteData.decryptedTitle = cached.title;
                        noteData.decryptedContent = cached.content;
                    }
                    return noteData;
                }); 
                currentNotes = newNotes;

                if (selectedNoteId) {
                    const selectedNoteExists = currentNotes.some(note => note.id === selectedNoteId);
                    if (!selectedNoteExists) {
                        showToast('warning', 'The selected note was modified or deleted elsewhere.');
                        clearNoteDisplay();
                    }
                }
                
                renderNotes(); 
                hideLoader(); 
            }, (err) => { 
                console.error(err); 
                showToast('error', 'Failed to load notes.');
                hideLoader(); 
            }); 
        }

        function loadTrash() { 
            if (!currentUser) return; 
            const trashCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'trash'); 
            if (trashUnsubscribe) trashUnsubscribe(); 
            trashUnsubscribe = onSnapshot(trashCollection, (snapshot) => { 
                trashedNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
            }); 
        }
        
        function loadAuditLogs() {
            if (!currentUser) return;
            const logsCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'audit_logs');
            const q = query(logsCollection, orderBy("timestamp", "desc"), limit(100));

            if (auditLogUnsubscribe) auditLogUnsubscribe();
            auditLogUnsubscribe = onSnapshot(q, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAuditLogs(logs);
            }, (err) => {
                console.error("Failed to load audit logs:", err);
                const listEl = el('audit-log-list');
                if (listEl) {
                    listEl.innerHTML = `<p class="text-red-500">Could not load audit logs. This may require a database index to be created.</p>`;
                }
            });
        }

        function renderNotes() {
            const searchTerm = searchNotesInput.value.toLowerCase(); const selectedTag = tagFilter.value;
            const filteredNotes = currentNotes.filter(n => (n.decryptedTitleCache?.toLowerCase().includes(searchTerm) || new Date(parseInt(n.id)).toLocaleString().toLowerCase().includes(searchTerm)) && (!selectedTag || (n.tags && n.tags.includes(selectedTag))));
            
            notesListEl.innerHTML = ''; // Clear previous content (including loader)

            // --- Optimization: Improved "no notes" message ---
            if (currentNotes.length === 0) {
                noNotesMsg.textContent = "You haven't created any notes yet.";
                noNotesMsg.classList.remove('hidden');
            } else if (filteredNotes.length === 0) {
                noNotesMsg.textContent = "No notes match your search.";
                noNotesMsg.classList.remove('hidden');
            } else {
                noNotesMsg.classList.add('hidden');
            }

            updateTagFilter();
            filteredNotes.sort((a, b) => (b.pinned || false) - (a.pinned || false) || b.id - a.id).forEach(note => {
                const noteEl = document.createElement('div');
                const color = note.color || 'transparent';
                noteEl.className = `note-item p-4 bg-dynamic-tertiary text-dynamic-secondary rounded-lg cursor-pointer border-l-4 hover:bg-gray-600 transition flex justify-between items-center`;
                noteEl.style.borderLeftColor = note.pinned ? '#f59e0b' : color;
                noteEl.dataset.id = note.id; noteEl.classList.toggle('selected', note.id === selectedNoteId);
                let titleText = note.decryptedTitleCache ? note.decryptedTitleCache : `Note - ${new Date(parseInt(note.id)).toLocaleString()}`;
                if (searchTerm) { titleText = titleText.replace(new RegExp(searchTerm, 'gi'), (match) => `<mark>${match}</mark>`); }
                const tagsHTML = (note.tags || []).map(tag => `<span class="note-tag text-dynamic-secondary">${tag}</span>`).join(' ');
                noteEl.innerHTML = `<div class="flex-grow overflow-hidden"><p class="truncate" title="${note.decryptedTitleCache || ''}">${titleText}</p><div class="flex gap-1 mt-1 flex-wrap">${tagsHTML}</div></div><div class="flex items-center gap-2 shrink-0"><button data-id="${note.id}" aria-label="Pin Note" class="pin-btn p-1 ${note.pinned ? 'text-yellow-400' : 'text-gray-500'} hover:text-yellow-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v1.063l5.243 5.242a1 1 0 01-.707 1.707H4.464a1 1 0 01-.707-1.707L9 5.063V4a1 1 0 011-1zM4.05 14a1 1 0 01.95.684l.5 2A1 1 0 006.452 18h7.096a1 1 0 00.951-1.316l.5-2a1 1 0 01.95-.684h0V14H4.05z" clip-rule="evenodd" /></svg></button><button data-id="${note.id}" aria-label="Delete Note" class="delete-btn p-1 text-gray-500 hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div>`;
                noteEl.addEventListener('click', (e) => { if (!e.target.closest('button')) handleNoteSelection(note.id); });
                noteEl.querySelector('.pin-btn').addEventListener('click', handlePinClick);
                noteEl.querySelector('.delete-btn').addEventListener('click', handleDeleteClick);
                notesListEl.appendChild(noteEl);
            });
        }
        
        function clearNoteDisplay() { 
            if (selectedNoteId) {
                decryptedCache.delete(selectedNoteId);
            }
            selectedNoteId = null; 
            noteContentDisplay.classList.add('hidden'); 
            selectNotePlaceholder.classList.remove('hidden'); 
            stopAutoLockTimer(); 
            renderNotes(); 
        }

        newNoteBtn.addEventListener('click', () => { const draft = getDraft(); if (draft) { el('confirm-title').textContent = 'Unsaved Draft'; el('confirm-message').textContent = 'You have an unsaved draft. Do you want to restore it?'; el('confirm-ok-btn').textContent = 'Restore'; openModal(confirmModal); confirmOkBtn.onclick = () => { openNoteForm(draft); closeModal(confirmModal); el('confirm-ok-btn').textContent = 'Delete'; }; el('confirm-cancel-btn').onclick = () => { clearDraft(); openNoteForm(); closeModal(confirmModal); el('confirm-ok-btn').textContent = 'Delete'; }; } else { openNoteForm(); } });
        function openNoteForm(data = {}) { noteForm.reset(); noteContentEditor.value = data.content || ''; noteTitleInput.value = data.title || ''; noteTagsInput.value = (data.tags || []).join(', '); updateColorPalette(data.color || null); checkPasswordStrength(''); el('note-id').value = data.id || ''; const isEditing = !!data.id; el('note-form-title').textContent = isEditing ? 'Edit Note' : 'Create New Note'; el('note-submit-btn').innerHTML = isEditing ? `Save Changes` : `Create & Encrypt`; updateCharCount(); openModal(noteFormModal); }
        editNoteBtn.addEventListener('click', () => { const note = currentNotes.find(n => n.id === selectedNoteId); if (!note || !note.decryptedTitle) return; openNoteForm({ id: note.id, title: note.decryptedTitle, content: note.decryptedContent, tags: note.tags, color: note.color }); });

        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const submitBtn = el('note-submit-btn');
            setButtonLoading(submitBtn, true);

            const id = el('note-id').value; const title = noteTitleInput.value;
            const content = noteContentEditor.value; const password = passwordInput.value;
            const tags = noteTagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
            const isNew = !id; 
            const noteId = id || Date.now().toString();
            const noteRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', noteId);
            
            const existingNote = isNew ? {} : currentNotes.find(n => n.id === id);
            const noteData = { title: encrypt(title, password), content: encrypt(content, password), attempts: 0, pinned: existingNote?.pinned || false, tags: tags, color: selectedColor };
            try { 
                await setDoc(noteRef, noteData, { merge: true });
                logActivity(isNew ? 'NOTE_CREATED' : 'NOTE_UPDATED', { noteId });
                decryptedCache.delete(noteId);
                showToast('success', `Note ${isNew ? 'created' : 'updated'}!`); 
                clearDraft(); 
                if (!isNew) clearNoteDisplay(); 
                closeModal(noteFormModal); 
            } catch (error) { 
                showToast('error', 'Failed to save note.'); 
                console.error(error); 
            } finally {
                setButtonLoading(submitBtn, false);
            }
        });

        function handleNoteSelection(noteId) { if (noteId === selectedNoteId) { showToast('warning', 'This note is already open.'); return; } const note = currentNotes.find(n => n.id === noteId); if (!note) return; decryptNoteForm.reset(); el('decrypt-note-id').value = noteId; el('decrypt-note-title').textContent = `Unlock: ${note.decryptedTitleCache || `Note from ${new Date(parseInt(note.id)).toLocaleString()}`}`; const attempts = note.attempts || 0; el('attempts-warning').textContent = attempts > 0 ? `Warning: ${MAX_ATTEMPTS - attempts} attempts remaining.` : ''; openModal(decryptNoteModal); }

        decryptNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const submitBtn = decryptNoteForm.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true, 'Decrypt');

            const noteId = el('decrypt-note-id').value; const password = el('decrypt-password').value;
            let note = currentNotes.find(n => n.id === noteId); if (!note) return;
            try {
                const decryptedTitle = decrypt(note.title, password); const decryptedContent = decrypt(note.content, password);
                logActivity('NOTE_DECRYPT_SUCCESS', { noteId });
                
                decryptedCache.set(noteId, { title: decryptedTitle, content: decryptedContent });

                note.decryptedTitle = decryptedTitle; note.decryptedContent = decryptedContent; note.decryptedTitleCache = decryptedTitle;
                noteTitleDisplay.textContent = decryptedTitle;
                const searchTerm = searchNotesInput.value;
                const renderedHTML = marked.parse(decryptedContent);
                noteBodyDisplay.innerHTML = searchTerm ? renderedHTML.replace(new RegExp(searchTerm, 'gi'), match => `<mark>${match}</mark>`) : renderedHTML;
                noteContentDisplay.classList.remove('hidden'); selectNotePlaceholder.classList.add('hidden'); selectedNoteId = noteId;
                if (note.attempts > 0) { await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', noteId), { attempts: 0 }, { merge: true }); }
                closeModal(decryptNoteModal); renderNotes(); startAutoLockTimer();
            } catch (error) {
                const attempts = (note.attempts || 0) + 1;
                const noteRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', noteId);
                logActivity('NOTE_DECRYPT_FAIL', { noteId, attempts });

                if (attempts >= MAX_ATTEMPTS) { 
                    await deleteDoc(noteRef); 
                    logActivity('NOTE_DELETED_MAX_ATTEMPTS', { noteId });
                    closeModal(decryptNoteModal); 
                    showToast('error', 'Note deleted due to too many failed attempts.'); 
                } else { 
                    await setDoc(noteRef, { attempts }, { merge: true }); 
                    showToast('warning', `Incorrect password. ${MAX_ATTEMPTS - attempts} attempts left.`); 
                    el('attempts-warning').textContent = `Warning: ${MAX_ATTEMPTS - attempts} attempts remaining.`; 
                }
            } finally {
                 setButtonLoading(submitBtn, false, 'Decrypt');
            }
        });

        async function handleDeleteClick(e) {
            const noteId = e.target.dataset.id;
            const note = currentNotes.find(n => n.id === noteId); if (!note) return;
            try {
                const noteRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', noteId);
                const trashRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'trash', noteId);
                const { decryptedTitle, decryptedContent, decryptedTitleCache, ...noteToTrash } = note;
                await setDoc(trashRef, { ...noteToTrash, trashedAt: Date.now() });
                await deleteDoc(noteRef);
                logActivity('NOTE_TRASHED', { noteId });
                decryptedCache.delete(noteId);
                showToast('success', 'Note moved to trash.');
                if (selectedNoteId === noteId) clearNoteDisplay();
            } catch (error) {
                showToast('error', 'Failed to move note to trash.');
                console.error(error);
            }
        }

        deleteConfirmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = deleteConfirmForm.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true);

            const noteId = el('delete-confirm-note-id').value;
            const password = el('delete-confirm-password').value;
            const titleInput = el('delete-confirm-title-input').value;
            const note = trashedNotes.find(n => n.id === noteId);
            
            if (!note) {
                setButtonLoading(submitBtn, false, 'Delete Permanently');
                return;
            }

            try {
                const decryptedTitle = decrypt(note.title, password);
                if (decryptedTitle !== titleInput) {
                    showToast('error', 'The entered title does not match.');
                    throw new Error("Title mismatch");
                }
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'trash', noteId));
                logActivity('NOTE_DELETED_PERMANENTLY', { noteId });
                showToast('success', 'Note permanently deleted.');
            } catch (error) {
                logActivity('NOTE_DELETE_PERM_FAIL', { noteId });
                if (error.message !== 'Title mismatch') {
                     showToast('error', 'Incorrect password. Deletion failed.');
                }
            } finally {
                closeModal(deleteConfirmModal);
                renderTrashList();
                setButtonLoading(submitBtn, false, 'Delete Permanently');
            }
        });

        async function handlePinClick(e) { 
            const noteId = e.target.dataset.id; 
            const note = currentNotes.find(n => n.id === noteId); 
            if (!note) return; 
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', noteId), { pinned: !note.pinned }, { merge: true }); 
                showToast('success', `Note ${!note.pinned ? 'pinned' : 'unpinned'}.`); 
            } catch (error) { 
                showToast('error', 'Failed to update pin status.'); 
            } 
        }
        
        copyNoteBtn.addEventListener('click', () => { 
            const note = currentNotes.find(n => n.id === selectedNoteId);
            if (!note || !note.decryptedContent) {
                showToast('error', 'Note is not available or has been locked. Please select it again.');
                if(selectedNoteId) clearNoteDisplay();
                return;
            }
            navigator.clipboard.writeText(note.decryptedContent).then(() => {
                showToast('success', 'Note content copied! It will be cleared from clipboard in 60 seconds.');
                setTimeout(() => {
                    navigator.clipboard.writeText(' ').catch(err => console.error("Could not clear clipboard."));
                }, 60000);
            }, () => showToast('error', 'Failed to copy.')); 
        });

        exportNoteBtn.addEventListener('click', () => { 
            const note = currentNotes.find(n => n.id === selectedNoteId);
            if (!note || !note.decryptedContent) {
                showToast('error', 'Note is not available or has been locked. Please select it again.');
                if(selectedNoteId) clearNoteDisplay();
                return;
            }
            const title = note.decryptedTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase(); 
            const content = note.decryptedContent; 
            const blob = new Blob([content], { type: 'text/plain' }); 
            const link = document.createElement('a'); 
            link.href = URL.createObjectURL(blob); 
            link.download = `${title || 'note'}.txt`; 
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
            showToast('success', 'Note exported!'); 
        });
        printNoteBtn.addEventListener('click', () => { 
            const note = currentNotes.find(n => n.id === selectedNoteId);
            if (!note || !note.decryptedContent) {
                showToast('error', 'Note is not available or has been locked. Please select it again.');
                if(selectedNoteId) clearNoteDisplay();
                return;
            }
            el('print-area').innerHTML = `<h1>${note.decryptedTitle}</h1><div class="prose prose-invert">${marked.parse(note.decryptedContent)}</div>`; 
            window.print(); 
        });

        // --- AI Feature Implementations ---
        aiSummarizeBtn.addEventListener('click', async () => {
            aiToolsDropdown.classList.add('hidden');
            const note = currentNotes.find(n => n.id === selectedNoteId);
            if (!note || !note.decryptedContent) { 
                showToast('error', 'Note is not available or has been locked. Please select it again.');
                if(selectedNoteId) clearNoteDisplay();
                return; 
            }
            showLoader();
            try {
                const prompt = `Provide a concise summary of the following text:\n\n---\n\n${note.decryptedContent}`;
                const summary = await callGemini(prompt);
                el('ai-result-title').textContent = 'Note Summary';
                el('ai-result-content').innerHTML = marked.parse(summary);
                openModal(aiResultModal);
            } catch (error) { showToast('error', 'Failed to generate summary.'); } finally { hideLoader(); }
        });

        aiProofreadBtn.addEventListener('click', async () => {
            aiToolsDropdown.classList.add('hidden');
            const note = currentNotes.find(n => n.id === selectedNoteId);
            if (!note || !note.decryptedContent) { 
                showToast('error', 'Note is not available or has been locked. Please select it again.');
                if(selectedNoteId) clearNoteDisplay();
                return;
            }
            showLoader();
            try {
                const prompt = `Proofread and correct any spelling or grammar mistakes in the following text. Only return the corrected text, without any introductory phrases or explanations.\n\n---\n\n${note.decryptedContent}`;
                const correctedText = await callGemini(prompt);
                openNoteForm({ id: note.id, title: note.decryptedTitle, content: correctedText, tags: note.tags, color: note.color });
                showToast('success', 'Proofreading complete. Review and save the changes.');
            } catch (error) { showToast('error', 'Failed to proofread note.'); } finally { hideLoader(); }
        });

        aiAssistantBtn.addEventListener('click', () => {
            aiToolsDropdown.classList.add('hidden');
            const note = currentNotes.find(n => n.id === selectedNoteId);
            if (!note || !note.decryptedContent) { 
                showToast('error', 'Note is not available or has been locked. Please select it again.');
                if(selectedNoteId) clearNoteDisplay();
                return; 
            }
            el('ai-prompt-input').value = '';
            openModal(aiAssistantModal);
        });

        aiAssistantForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const generateBtn = el('ai-generate-btn');
            setButtonLoading(generateBtn, true, 'Generate');
            const prompt = el('ai-prompt-input').value;
            try {
                const generatedContent = await callGemini(prompt);
                const note = currentNotes.find(n => n.id === selectedNoteId);
                openNoteForm({ id: note.id, title: note.decryptedTitle, content: `${note.decryptedContent}\n\n---\n*AI Generated Content:*\n${generatedContent}`, tags: note.tags, color: note.color });
                closeModal(aiAssistantModal);
                showToast('success', 'AI content generated and added to the editor.');
            } catch (error) { showToast('error', 'Failed to generate content.'); } finally { setButtonLoading(generateBtn, false, 'Generate'); }
        });

        aiToolsBtn.addEventListener('click', (e) => { e.stopPropagation(); aiToolsDropdown.classList.toggle('hidden'); });

        // --- Helper & UI Functions ---
        const saveDraft = () => localStorage.setItem('noteDraft', JSON.stringify({ title: noteTitleInput.value, content: noteContentEditor.value, tags: noteTagsInput.value, color: selectedColor }));
        const getDraft = () => JSON.parse(localStorage.getItem('noteDraft')); const clearDraft = () => localStorage.removeItem('noteDraft');
        const updateCharCount = () => { const text = noteContentEditor.value; const charCount = text.length; const wordCount = text.trim().split(/\s+/).filter(Boolean).length; editorCharCount.textContent = `${charCount} characters, ${wordCount} words`; };

        const startAutoLockTimer = () => { 
            stopAutoLockTimer(); 
            sessionWarningTimer = setTimeout(() => {
                let secondsLeft = SESSION_WARNING_TIME / 1000;
                el('session-countdown').textContent = secondsLeft;
                openModal(sessionWarningModal);
                sessionCountdownInterval = setInterval(() => {
                    secondsLeft--;
                    el('session-countdown').textContent = secondsLeft;
                    if (secondsLeft <= 0) clearInterval(sessionCountdownInterval);
                }, 1000);
            }, AUTO_LOCK_TIME - SESSION_WARNING_TIME);
            autoLockTimer = setTimeout(() => { 
                closeModal(sessionWarningModal);
                clearNoteDisplay(); 
                showToast('warning', 'Note locked due to inactivity.'); 
            }, AUTO_LOCK_TIME); 
        };
        const stopAutoLockTimer = () => { clearTimeout(autoLockTimer); clearTimeout(sessionWarningTimer); clearInterval(sessionCountdownInterval); }; 
        const resetAutoLockTimer = () => { if(selectedNoteId) startAutoLockTimer(); };
        
        const checkPasswordStrength = (password) => { let score = 0; if (password.length > 8) score++; if (password.match(/[a-z]/)) score++; if (password.match(/[A-Z]/)) score++; if (password.match(/[0-9]/)) score++; if (password.match(/[^a-zA-Z0-9]/)) score++; strengthBar.classList.remove('strength-weak', 'strength-medium', 'strength-strong'); if (score <= 2) { strengthBar.style.width = '33%'; strengthBar.classList.add('strength-weak'); } else if (score <= 4) { strengthBar.style.width = '66%'; strengthBar.classList.add('strength-medium'); } else { strengthBar.style.width = '100%'; strengthBar.classList.add('strength-strong'); } };
        const updateTagFilter = () => { const tags = [...new Set(currentNotes.flatMap(n => n.tags || []))]; const currentVal = tagFilter.value; tagFilter.innerHTML = '<option value="">All Tags</option>'; tags.forEach(tag => tagFilter.innerHTML += `<option value="${tag}">${tag}</option>`); tagFilter.value = currentVal; };
        const updateColorPalette = (activeColor) => { selectedColor = activeColor; colorPalette.innerHTML = ''; NOTE_COLORS.forEach(color => { const swatch = document.createElement('div'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = color; if (color === activeColor) swatch.classList.add('selected'); swatch.onclick = () => updateColorPalette(color); colorPalette.appendChild(swatch); }); };

        let isTransitioning = false;
        const initialSetTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); el('theme-icon-sun').classList.toggle('hidden', theme === 'dark'); el('theme-icon-moon').classList.toggle('hidden', theme === 'light'); };
        const setTheme = (theme, e) => { if (isTransitioning) return; isTransitioning = true; const x = e.clientX; const y = e.clientY; const endRadius = Math.hypot(Math.max(x, window.innerWidth - x), Math.max(y, window.innerHeight - y)); const overlay = document.createElement('div'); overlay.className = 'theme-transition-overlay'; const targetBgColor = theme === 'dark' ? '#111827' : '#f9fafb'; overlay.style.backgroundColor = targetBgColor; overlay.style.setProperty('--x', `${x}px`); overlay.style.setProperty('--y', `${y}px`); document.body.appendChild(overlay); overlay.addEventListener('transitionend', () => { initialSetTheme(theme); overlay.remove(); isTransitioning = false; }, { once: true }); requestAnimationFrame(() => { overlay.style.clipPath = `circle(${endRadius}px at var(--x) var(--y))`; }); };
        themeToggleBtn.addEventListener('click', (e) => { const newTheme = (localStorage.getItem('theme') || 'dark') === 'dark' ? 'light' : 'dark'; setTheme(newTheme, e); });
        
        backupBtn.addEventListener('click', () => openModal(backupModal));
        el('export-form').addEventListener('submit', async (e) => { e.preventDefault(); const password = el('export-password').value; if (!password) { showToast('error', 'Backup password is required.'); return; } const allNotesSnapshot = await getDocs(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notes')); const allNotes = allNotesSnapshot.docs.map(d => ({id: d.id, ...d.data()})); const data = encrypt(JSON.stringify(allNotes), password); const blob = new Blob([data], { type: 'application/json' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `secure-notes-backup-${Date.now()}.json`; link.click(); logActivity('DATA_EXPORTED'); showToast('success', 'Encrypted backup exported.'); });
        el('import-form').addEventListener('submit', (e) => { e.preventDefault(); const file = el('import-file').files[0]; const password = el('import-password').value; if (!file || !password) { showToast('error', 'File and password are required.'); return; } const reader = new FileReader(); reader.onload = async (event) => { try { const decrypted = decrypt(event.target.result, password); const notesToImport = JSON.parse(decrypted); const batch = writeBatch(db); for (const note of notesToImport) { const noteRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', note.id); batch.set(noteRef, note); } await batch.commit(); logActivity('DATA_IMPORTED', { noteCount: notesToImport.length }); showToast('success', `${notesToImport.length} notes imported successfully.`); closeModal(backupModal); } catch (err) { logActivity('DATA_IMPORT_FAIL'); showToast('error', 'Import failed. Check password or file.'); } }; reader.readAsText(file); });
        
        editorTabEdit.addEventListener('click', () => { noteContentEditor.classList.remove('hidden'); noteContentPreview.classList.add('hidden'); editorTabEdit.classList.add('active'); editorTabPreview.classList.remove('active'); });
        editorTabPreview.addEventListener('click', () => { noteContentEditor.classList.add('hidden'); noteContentPreview.classList.remove('hidden'); editorTabEdit.classList.remove('active'); editorTabPreview.classList.add('active'); noteContentPreview.innerHTML = marked.parse(noteContentEditor.value); });
        trashBtn.addEventListener('click', () => { renderTrashList(); openModal(trashModal); });
        auditLogBtn.addEventListener('click', () => openModal(auditLogModal));
        
        function renderTrashList() {
            const trashListEl = el('trash-list');
            el('no-trash-msg').classList.toggle('hidden', trashedNotes.length > 0);
            trashListEl.innerHTML = '';
            trashedNotes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'p-4 bg-dynamic-tertiary rounded-lg flex justify-between items-center';
                noteEl.innerHTML = `<div><p>${note.decryptedTitleCache || `Note from ${new Date(parseInt(note.id)).toLocaleString()}`}</p><p class="text-xs text-gray-500">Trashed: ${new Date(note.trashedAt).toLocaleDateString()}</p></div><div class="flex gap-2"><button data-id="${note.id}" class="restore-btn text-green-500 hover:text-green-400">Restore</button><button data-id="${note.id}" class="perm-delete-btn text-red-500 hover:text-red-400">Delete</button></div>`;
                noteEl.querySelector('.restore-btn').addEventListener('click', async () => {
                    const { trashedAt, ...originalNote } = note;
                    const noteId = note.id;
                    await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', noteId), originalNote);
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'trash', noteId));
                    logActivity('NOTE_RESTORED', { noteId });
                    showToast('success', 'Note restored.');
                    renderTrashList();
                });
                noteEl.querySelector('.perm-delete-btn').addEventListener('click', () => {
                    deleteConfirmForm.reset();
                    el('delete-confirm-note-id').value = note.id;
                    const title = note.decryptedTitleCache || `Note from ${new Date(parseInt(note.id)).toLocaleString()}`;
                    el('delete-confirm-text').innerHTML = `You are about to permanently delete: <strong class="text-red-400">${title}</strong>`;
                    openModal(deleteConfirmModal);
                });
                trashListEl.appendChild(noteEl);
            });
        }

        function renderAuditLogs(logs) {
            const listEl = el('audit-log-list');
            if (!listEl) return;

            listEl.innerHTML = ''; // Clear previous logs

            if (logs.length === 0) {
                listEl.innerHTML = '<p class="text-dynamic-secondary">No audit log entries found.</p>';
                return;
            }

            logs.forEach(log => {
                const logEl = document.createElement('div');
                logEl.className = 'p-3 bg-dynamic-tertiary rounded-lg text-sm';

                const timestamp = new Date(log.timestamp).toLocaleString();
                const actionText = log.action.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                
                let detailsText = '';
                if (log.details && Object.keys(log.details).length > 0) {
                    try {
                        const detailsString = JSON.stringify(log.details);
                         detailsText = `<div class="text-xs text-gray-400 mt-1 pl-2 border-l-2 border-gray-600">Details: ${detailsString}</div>`;
                    } catch(e) { /* ignore circular refs */ }
                }

                logEl.innerHTML = `
                    <div>
                        <span class="font-semibold text-purple-400">${actionText}</span>
                        <span class="text-xs text-gray-500 float-right">${timestamp}</span>
                    </div>
                    ${detailsText}
                `;
                listEl.appendChild(logEl);
            });
        }
        
        // --- Event Listeners Setup ---
        masterPasswordSetupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const pass1 = el('master-password-create').value;
            const pass2 = el('master-password-confirm').value;
            if(pass1.length < 8) { showToast('error', 'Password must be at least 8 characters.'); return; }
            if (pass1 !== pass2) { showToast('error', 'Passwords do not match.'); return; }
            const salt = CryptoJS.lib.WordArray.random(128 / 8).toString();
            const encryptedCheck = encrypt("SECURE_E_NOTES_CHECK", pass1);
            localStorage.setItem(MASTER_PASS_CONFIG.saltKey, salt);
            localStorage.setItem(MASTER_PASS_CONFIG.checkKey, encryptedCheck);
            closeModal(appLockModal);
            el('app-container').classList.remove('hidden');
            completeLogin();
        });

        masterPasswordLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = el('master-password-input').value;
            const encryptedCheck = localStorage.getItem(MASTER_PASS_CONFIG.checkKey);
            try {
                const decryptedCheck = decrypt(encryptedCheck, password);
                if(decryptedCheck === "SECURE_E_NOTES_CHECK") {
                    logActivity('MASTER_LOGIN_SUCCESS');
                    closeModal(appLockModal);
                    el('app-container').classList.remove('hidden');
                    completeLogin();
                } else {
                    throw new Error("Incorrect Password");
                }
            } catch(err) {
                logActivity('MASTER_LOGIN_FAIL');
                showToast('error', 'Incorrect master password.');
            }
        });

        el('session-extend-btn').addEventListener('click', () => {
            closeModal(sessionWarningModal);
            resetAutoLockTimer();
            showToast('success', 'Session extended.');
        });

        el('session-lock-now-btn').addEventListener('click', () => {
             closeModal(sessionWarningModal);
             stopAutoLockTimer();
             clearNoteDisplay();
             showToast('warning', 'Note locked.');
        });
        
        passwordInput.addEventListener('input', (e) => checkPasswordStrength(e.target.value)); 
        [searchNotesInput, tagFilter].forEach(el => el.addEventListener('input', renderNotes));
        [noteTitleInput, noteTagsInput].forEach(el => el.addEventListener('input', saveDraft));
        noteContentEditor.addEventListener('input', () => { saveDraft(); updateCharCount(); });
        ['mousemove', 'mousedown', 'keydown', 'scroll'].forEach(event => window.addEventListener(event, resetAutoLockTimer));
        
        window.addEventListener('click', (e) => {
            if (!aiToolsBtn.contains(e.target) && !aiToolsDropdown.contains(e.target)) {
                aiToolsDropdown.classList.add('hidden');
            }
        });
        
        setInterval(() => { el('date-time').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }); }, 1000);
        initialSetTheme(localStorage.getItem('theme') || 'dark');
        
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.onclick = () => cancelBtnHandler(btn));
        document.querySelectorAll('.modal-overlay').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) { if (modal === noteFormModal) { clearDraft(); } closeModal(modal); } }); });
        
        // --- App Initialization ---
        // A simple inline script will handle the initial display of the lock modal.
        // This module script will attach the form handlers once it's loaded.
    </script>
    <script>
        // This script runs immediately, without waiting for modules, to show the login UI.
        (function() {
            const el = (id) => document.getElementById(id);
            const appLockModal = el('app-lock-modal');
            const masterPasswordSetup = el('master-password-setup');
            const masterPasswordLogin = el('master-password-login');
            const MASTER_PASS_SALT_KEY = 'masterPassSalt';

            if (appLockModal) {
                appLockModal.classList.add('active');
            }

            const salt = localStorage.getItem(MASTER_PASS_SALT_KEY);
            if (salt) {
                if(masterPasswordSetup) masterPasswordSetup.classList.add('hidden');
                if(masterPasswordLogin) masterPasswordLogin.classList.remove('hidden');
            } else {
                if(masterPasswordSetup) masterPasswordSetup.classList.remove('hidden');
                if(masterPasswordLogin) masterPasswordLogin.classList.add('hidden');
            }
        })();
    </script>
</body>
</html>

