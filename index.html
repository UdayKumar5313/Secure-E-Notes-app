<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111827; 
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --accent-primary: #6d28d9; /* Deep Purple */
            --accent-secondary: #db2777; /* Fuchsia */
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
        }

        [data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .theme-transition-overlay { position: fixed; inset: 0; z-index: 9999; pointer-events: none; clip-path: circle(0% at var(--x) var(--y)); transition: clip-path 1.2s cubic-bezier(0.65, 0, 0.35, 1); }
        .bg-dynamic-primary { background-color: var(--bg-primary); }
        .bg-dynamic-secondary { background-color: var(--bg-secondary); }
        .bg-dynamic-tertiary { background-color: var(--bg-tertiary); }
        .text-dynamic-primary { color: var(--text-primary); }
        .text-dynamic-secondary { color: var(--text-secondary); }
        .border-dynamic { border-color: var(--border-color); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 550px; transform: scale(0.95); transition: transform 0.3s ease; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .note-item.selected { background-color: var(--accent-primary) !important; color: white !important; }
        .note-item.pinned { border-left-color: #f59e0b !important; }
        
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); color: white; opacity: 0; transform: translateX(100%); transition: all 0.4s ease-in-out; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #059669; } .toast-error { background-color: #dc2626; } .toast-warning { background-color: #d97706; }

        #loader-overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 200; transition: opacity 0.3s ease; }
        .loader { width: 48px; height: 48px; border: 5px solid var(--text-primary); border-bottom-color: var(--accent-primary); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #password-strength-bar { height: 5px; width: 0%; border-radius: 5px; transition: width 0.3s ease, background-color 0.3s ease; }
        .strength-weak { background-color: #ef4444; } .strength-medium { background-color: #f59e0b; } .strength-strong { background-color: #10b981; }

        .color-swatch { width: 24px; height: 24px; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: var(--accent-secondary); transform: scale(1.1); }
        .note-tag { background-color: var(--bg-tertiary); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; }
        mark { background-color: #f59e0b; color: #111827; padding: 0 2px; border-radius: 2px; }

        /* Markdown Editor Styles */
        .editor-tabs button { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; }
        .editor-tabs button.active { border-bottom-color: var(--accent-primary); color: var(--accent-primary); }
        #note-content-editor { font-family: monospace; }
        #note-content-preview { min-height: 10rem; }
        #note-content-preview > *:first-child { margin-top: 0; }
        #note-content-preview > *:last-child { margin-bottom: 0; }

        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>

<body class="bg-dynamic-primary text-dynamic-primary">
    
    <div id="loader-overlay"><div class="loader"></div></div>
    <div id="toast-container"></div>
    <div id="print-area" class="hidden"></div>
    <div id="app-container">
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-dynamic pb-6">
                <div>
                    <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-pink-500">Secure E-Notes</h1>
                    <p class="text-dynamic-secondary">Your encrypted notes, safely stored.</p>
                </div>
                 <div class="flex items-center gap-4 mt-4 md:mt-0">
                    <div id="date-time" class="text-lg font-semibold text-dynamic-secondary text-center md:text-right"></div>
                    <button id="trash-btn" class="p-2 rounded-full hover:bg-dynamic-tertiary transition" title="View Trash"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    <button id="backup-btn" class="p-2 rounded-full hover:bg-dynamic-tertiary transition" title="Import/Export Notes"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7v4c0 2.21 3.582 4 8 4s8-1.79 8-4V7" /></svg></button>
                     <button id="theme-toggle" class="p-2 rounded-full hover:bg-dynamic-tertiary transition">
                        <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                     </button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <button id="new-note-btn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Create New Note
                    </button>
                    <div class="bg-dynamic-secondary p-6 rounded-2xl shadow-2xl flex-grow">
                        <h2 class="text-2xl font-semibold mb-4 text-dynamic-primary">Your Notes</h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="search-notes" placeholder="Search notes..." class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-dynamic-primary">
                            <select id="tag-filter" class="bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-dynamic-primary"><option value="">All Tags</option></select>
                        </div>
                        <div id="notes-list" class="space-y-3 h-96 overflow-y-auto pr-2"></div>
                        <p id="no-notes-msg" class="text-gray-500 text-center mt-8 hidden">No notes found.</p>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-dynamic-secondary p-8 rounded-2xl shadow-2xl flex flex-col items-center justify-center min-h-[30rem]">
                    <div id="note-content-display" class="w-full h-full hidden flex flex-col">
                        <div class="flex justify-between items-center mb-4 gap-4">
                            <h2 id="note-title-display" class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400 truncate"></h2>
                            <div class="flex gap-2 shrink-0">
                                <button id="share-note-btn" title="Share Note" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg></button>
                                <button id="print-note-btn" title="Print Note" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h10a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg></button>
                                <button id="export-note-btn" title="Export as .txt" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                                <button id="copy-note-btn" title="Copy Content" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg></button>
                                <button id="edit-note-btn" title="Edit Note" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            </div>
                        </div>
                        <div id="note-body-display" class="text-dynamic-secondary prose prose-invert max-w-none bg-dynamic-primary p-6 rounded-lg flex-grow overflow-y-auto"></div>
                    </div>
                    <div id="select-note-placeholder" class="text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg><h3 class="text-2xl font-semibold">Select a Note</h3><p>Choose a note from the list to view its encrypted content.</p></div>
                </div>
            </main>
            <footer class="text-center text-gray-500 mt-8 pt-6 border-t border-dynamic">
                <p>Developed by <a href="https://www.linkedin.com/in/uday-kumar-cybersecurity?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" rel="noopener noreferrer" class="text-purple-400 hover:underline">Uday Kumar</a></p>
                <p id="user-id-display" class="text-xs mt-2 truncate"></p>
            </footer>
        </div>
    </div>
    
    <div id="share-view-container" class="hidden"></div>
    
    <!-- Modals -->
    <div id="note-form-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary">
            <h2 id="note-form-title" class="text-2xl font-bold mb-6"></h2>
            <form id="note-form">
                <input type="hidden" id="note-id">
                <div class="mb-4">
                    <label for="note-title" class="block mb-2 font-semibold">Title</label>
                    <input type="text" id="note-title" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-4">
                    <div class="editor-tabs flex border-b border-dynamic mb-2"><button type="button" id="editor-tab-edit" class="active">Edit</button><button type="button" id="editor-tab-preview">Preview</button></div>
                    <textarea id="note-content-editor" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 h-40"></textarea>
                    <div id="note-content-preview" class="hidden p-4 prose prose-invert max-w-none bg-dynamic-tertiary rounded-lg h-40 overflow-y-auto"></div>
                    <div id="editor-char-count" class="text-xs text-right text-dynamic-secondary mt-1"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label for="note-tags" class="block mb-2 font-semibold">Tags (comma-separated)</label><input type="text" id="note-tags" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4"></div>
                    <div><label class="block mb-2 font-semibold">Color</label><div id="color-palette" class="flex gap-2 items-center"></div></div>
                </div>
                <div class="mb-2"><label for="note-password" class="block mb-2 font-semibold">Encryption Password</label><input type="password" id="note-password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4" required placeholder="Enter password to save"></div>
                <div class="mb-6"><div class="bg-gray-700 rounded-lg overflow-hidden"><div id="password-strength-bar"></div></div></div>
                <div class="flex justify-end gap-4"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" id="note-submit-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"></button></div>
            </form>
        </div>
    </div>
    
    <div id="decrypt-note-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary"><h2 class="text-2xl font-bold mb-2">Enter Password</h2><p id="decrypt-note-title" class="text-dynamic-secondary mb-4"></p><p id="attempts-warning" class="text-red-500 text-sm mb-4 h-5 font-semibold"></p><form id="decrypt-note-form"><input type="hidden" id="decrypt-note-id"><input type="password" id="decrypt-password" placeholder="Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required><div class="flex justify-end gap-4"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg">Decrypt</button></div></form></div>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary"><h2 class="text-2xl font-bold mb-2">Confirm Deletion</h2><p id="delete-confirm-title" class="text-dynamic-secondary mb-4"></p><p class="text-sm text-red-500 mb-4">This action is irreversible. Please enter the password to proceed.</p><form id="delete-confirm-form"><input type="hidden" id="delete-confirm-note-id"><input type="password" id="delete-confirm-password" placeholder="Note Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required><div class="flex justify-end gap-4"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Delete Permanently</button></div></form></div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content text-center bg-dynamic-secondary text-dynamic-primary"><h2 id="confirm-title" class="text-2xl font-bold mb-4">Are you sure?</h2><p id="confirm-message" class="mb-6 text-lg text-dynamic-secondary"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button><button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Delete</button></div></div>
    </div>

    <div id="backup-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary"><h2 class="text-2xl font-bold mb-6">Backup & Restore</h2><div class="mb-6 border-b border-dynamic pb-6"><h3 class="font-semibold mb-2">Export Notes</h3><p class="text-sm text-dynamic-secondary mb-4">Create an encrypted backup of all your notes. Keep this password safe.</p><form id="export-form"><input type="password" id="export-password" placeholder="Backup Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Export Encrypted File</button></form></div><div><h3 class="font-semibold mb-2">Import Notes</h3><p class="text-sm text-dynamic-secondary mb-4">Restore notes from an encrypted backup file. This will overwrite notes with the same creation date.</p><form id="import-form"><input type="file" id="import-file" accept=".json" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 mb-4" required><input type="password" id="import-password" placeholder="Backup Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Import Notes</button></form></div></div>
    </div>

    <div id="trash-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary w-full max-w-2xl"><h2 class="text-2xl font-bold mb-4">Trash</h2><p class="text-sm text-dynamic-secondary mb-4">Notes in trash will be permanently deleted after 30 days.</p><div id="trash-list" class="space-y-3 h-96 overflow-y-auto pr-2"></div><p id="no-trash-msg" class="text-gray-500 text-center mt-8 hidden">Trash is empty.</p></div>
    </div>
    
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary"><h2 class="text-2xl font-bold mb-2">Share Note</h2><p class="text-sm text-dynamic-secondary mb-4">A secure, shareable link has been generated. The recipient will need the note's password to decrypt it.</p><input type="text" id="share-link-input" readonly class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4"><div class="flex justify-end gap-4"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Close</button><button id="copy-share-link-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Copy Link</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBDzoObYxGLMhP8_-xkOsWp2fvXWYlWniY", authDomain: "adaptistudy.firebaseapp.com", projectId: "adaptistudy",
          storageBucket: "adaptistudy.appspot.com", messagingSenderId: "881929223792", appId: "1:881929223792:web:ccc93653fa969e3cfa3eb5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; let notesUnsubscribe = null; let trashUnsubscribe = null; let currentNotes = []; let trashedNotes = [];
        let selectedNoteId = null; let selectedColor = null;
        const MAX_ATTEMPTS = 5; let autoLockTimer = null; const AUTO_LOCK_TIME = 3 * 60 * 1000;
        const NOTE_COLORS = ['#34d399', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899'];

        const el = (id) => document.getElementById(id);
        const loaderOverlay = el('loader-overlay'); const showLoader = () => loaderOverlay.style.display = 'flex'; const hideLoader = () => loaderOverlay.style.display = 'none';
        const newNoteBtn = el('new-note-btn'), notesListEl = el('notes-list'), noNotesMsg = el('no-notes-msg');
        const searchNotesInput = el('search-notes'), noteContentDisplay = el('note-content-display'), selectNotePlaceholder = el('select-note-placeholder');
        const noteTitleDisplay = el('note-title-display'), noteBodyDisplay = el('note-body-display'), themeToggleBtn = el('theme-toggle');
        const noteFormModal = el('note-form-modal'), decryptNoteModal = el('decrypt-note-modal'), confirmModal = el('confirm-modal');
        const noteForm = el('note-form'), decryptNoteForm = el('decrypt-note-form'), editNoteBtn = el('edit-note-btn'), copyNoteBtn = el('copy-note-btn');
        const exportNoteBtn = el('export-note-btn'), printNoteBtn = el('print-note-btn'), passwordInput = el('note-password');
        const strengthBar = el('password-strength-bar'), noteContentEditor = el('note-content-editor'), noteTitleInput = el('note-title');
        const tagFilter = el('tag-filter'), noteTagsInput = el('note-tags'), colorPalette = el('color-palette');
        const editorCharCount = el('editor-char-count'); const backupBtn = el('backup-btn'); const backupModal = el('backup-modal');
        const deleteConfirmModal = el('delete-confirm-modal'); const deleteConfirmForm = el('delete-confirm-form');
        const confirmOkBtn = el('confirm-ok-btn');
        const editorTabEdit = el('editor-tab-edit'), editorTabPreview = el('editor-tab-preview'), noteContentPreview = el('note-content-preview');
        const trashBtn = el('trash-btn'), trashModal = el('trash-modal');
        const shareNoteBtn = el('share-note-btn'), shareModal = el('share-modal');

        const showToast = (type, message) => { const toast = document.createElement('div'); toast.className = `toast toast-${type}`; toast.textContent = message; el('toast-container').appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 5000); };
        const encrypt = (text, password) => CryptoJS.AES.encrypt(text, password).toString();
        const decrypt = (ciphertext, password) => { const bytes = CryptoJS.AES.decrypt(ciphertext, password); const decryptedText = bytes.toString(CryptoJS.enc.Utf8); if (!decryptedText) throw new Error("Decryption failed"); return decryptedText; };
        
        const closeModal = (modal) => modal.classList.remove('active');
        const openModal = (modalToOpen) => {
            // Close any currently open modals first
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                if (modal !== modalToOpen) {
                    closeModal(modal);
                }
            });
            modalToOpen.classList.add('active');
        };
        const cancelBtnHandler = (btn) => { const modal = btn.closest('.modal-overlay'); if (modal === noteFormModal) { clearDraft(); } closeModal(modal); };
        
        function handleAppLoad() {
            const hash = window.location.hash;
            if (hash.startsWith('#share=')) {
                handleSharedNote(hash.substring(7));
            } else {
                el('app-container').classList.remove('hidden');
                onAuthStateChanged(auth, user => { if (user) { currentUser = user; el('user-id-display').textContent = `User ID: ${user.uid}`; loadNotes(); loadTrash(); } else { signInAnonymously(auth).catch(err => { console.error(err); hideLoader(); }); } });
            }
        }
        
        function loadNotes() { if (!currentUser) return; const notesCollection = collection(db, 'users', currentUser.uid, 'notes'); if (notesUnsubscribe) notesUnsubscribe(); notesUnsubscribe = onSnapshot(notesCollection, (snapshot) => { currentNotes = snapshot.docs.map(doc => { const existing = currentNotes.find(n => n.id === doc.id); return { id: doc.id, ...doc.data(), decryptedTitleCache: existing?.decryptedTitleCache, decryptedContent: existing?.decryptedContent, decryptedTitle: existing?.decryptedTitle }; }); renderNotes(); hideLoader(); }, (err) => { console.error(err); hideLoader(); }); }
        function loadTrash() { if (!currentUser) return; const trashCollection = collection(db, 'users', currentUser.uid, 'trash'); if (trashUnsubscribe) trashUnsubscribe(); trashUnsubscribe = onSnapshot(trashCollection, (snapshot) => { trashedNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); }); }
        
        function renderNotes() {
            const searchTerm = searchNotesInput.value.toLowerCase(); const selectedTag = tagFilter.value;
            const filteredNotes = currentNotes.filter(n => (n.decryptedTitleCache?.toLowerCase().includes(searchTerm) || new Date(parseInt(n.id)).toLocaleString().toLowerCase().includes(searchTerm)) && (!selectedTag || (n.tags && n.tags.includes(selectedTag))));
            notesListEl.innerHTML = ''; noNotesMsg.classList.toggle('hidden', currentNotes.length > 0);
            updateTagFilter();
            filteredNotes.sort((a, b) => (b.pinned || false) - (a.pinned || false) || b.id - a.id).forEach(note => {
                const noteEl = document.createElement('div');
                const color = note.color || 'transparent';
                noteEl.className = `note-item p-4 bg-dynamic-tertiary text-dynamic-secondary rounded-lg cursor-pointer border-l-4 hover:bg-gray-600 transition flex justify-between items-center`;
                noteEl.style.borderLeftColor = note.pinned ? '#f59e0b' : color;
                noteEl.dataset.id = note.id; noteEl.classList.toggle('selected', note.id === selectedNoteId);
                let titleText = note.decryptedTitleCache ? note.decryptedTitleCache : `Note - ${new Date(parseInt(note.id)).toLocaleString()}`;
                if (searchTerm) { titleText = titleText.replace(new RegExp(searchTerm, 'gi'), (match) => `<mark>${match}</mark>`); }
                const tagsHTML = (note.tags || []).map(tag => `<span class="note-tag text-dynamic-secondary">${tag}</span>`).join(' ');
                noteEl.innerHTML = `<div class="flex-grow overflow-hidden"><p class="truncate" title="${note.decryptedTitleCache || ''}">${titleText}</p><div class="flex gap-1 mt-1 flex-wrap">${tagsHTML}</div></div><div class="flex items-center gap-2 shrink-0"><button data-id="${note.id}" title="Pin Note" class="pin-btn p-1 ${note.pinned ? 'text-yellow-400' : 'text-gray-500'} hover:text-yellow-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v1.063l5.243 5.242a1 1 0 01-.707 1.707H4.464a1 1 0 01-.707-1.707L9 5.063V4a1 1 0 011-1zM4.05 14a1 1 0 01.95.684l.5 2A1 1 0 006.452 18h7.096a1 1 0 00.951-1.316l.5-2a1 1 0 01.95-.684h0V14H4.05z" clip-rule="evenodd" /></svg></button><button data-id="${note.id}" title="Delete Note" class="delete-btn p-1 text-gray-500 hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div>`;
                noteEl.addEventListener('click', (e) => { if (!e.target.closest('button')) handleNoteSelection(note.id); });
                noteEl.querySelector('.pin-btn').addEventListener('click', handlePinClick);
                noteEl.querySelector('.delete-btn').addEventListener('click', handleDeleteClick);
                notesListEl.appendChild(noteEl);
            });
        }
        
        function clearNoteDisplay() { selectedNoteId = null; noteContentDisplay.classList.add('hidden'); selectNotePlaceholder.classList.remove('hidden'); stopAutoLockTimer(); renderNotes(); }

        newNoteBtn.addEventListener('click', () => { const draft = getDraft(); if (draft) { el('confirm-title').textContent = 'Unsaved Draft'; el('confirm-message').textContent = 'You have an unsaved draft. Do you want to restore it?'; el('confirm-ok-btn').textContent = 'Restore'; openModal(confirmModal); confirmOkBtn.onclick = () => { openNoteForm(draft); closeModal(confirmModal); el('confirm-ok-btn').textContent = 'Delete'; }; el('confirm-cancel-btn').onclick = () => { clearDraft(); openNoteForm(); closeModal(confirmModal); el('confirm-ok-btn').textContent = 'Delete'; }; } else { openNoteForm(); } });
        function openNoteForm(data = {}) { noteForm.reset(); noteContentEditor.value = data.content || ''; noteTitleInput.value = data.title || ''; noteTagsInput.value = (data.tags || []).join(', '); updateColorPalette(data.color || null); checkPasswordStrength(''); el('note-id').value = data.id || ''; const isEditing = !!data.id; el('note-form-title').textContent = isEditing ? 'Edit Note' : 'Create New Note'; el('note-submit-btn').innerHTML = isEditing ? `Save Changes` : `Create & Encrypt`; updateCharCount(); openModal(noteFormModal); }
        editNoteBtn.addEventListener('click', () => { const note = currentNotes.find(n => n.id === selectedNoteId); if (!note || !note.decryptedTitle) return; openNoteForm({ id: note.id, title: note.decryptedTitle, content: note.decryptedContent, tags: note.tags, color: note.color }); });

        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const id = el('note-id').value; const title = noteTitleInput.value;
            const content = noteContentEditor.value; const password = passwordInput.value;
            const tags = noteTagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
            const isNew = !id; const noteRef = doc(db, 'users', currentUser.uid, 'notes', id || Date.now().toString());
            const existingNote = isNew ? {} : currentNotes.find(n => n.id === id);
            const noteData = { title: encrypt(title, password), content: encrypt(content, password), attempts: 0, pinned: existingNote?.pinned || false, tags: tags, color: selectedColor };
            try { await setDoc(noteRef, noteData, { merge: true }); showToast('success', `Note ${isNew ? 'created' : 'updated'}!`); clearDraft(); if (!isNew) clearNoteDisplay(); closeModal(noteFormModal); } 
            catch (error) { showToast('error', 'Failed to save note.'); console.error(error); }
        });

        function handleNoteSelection(noteId) { if (noteId === selectedNoteId) { showToast('warning', 'This note is already open.'); return; } const note = currentNotes.find(n => n.id === noteId); if (!note) return; decryptNoteForm.reset(); el('decrypt-note-id').value = noteId; el('decrypt-note-title').textContent = `Unlock: ${note.decryptedTitleCache || `Note from ${new Date(parseInt(note.id)).toLocaleString()}`}`; const attempts = note.attempts || 0; el('attempts-warning').textContent = attempts > 0 ? `Warning: ${MAX_ATTEMPTS - attempts} attempts remaining.` : ''; openModal(decryptNoteModal); }

        decryptNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const noteId = el('decrypt-note-id').value; const password = el('decrypt-password').value;
            let note = currentNotes.find(n => n.id === noteId); if (!note) return;
            try {
                const decryptedTitle = decrypt(note.title, password); const decryptedContent = decrypt(note.content, password);
                note.decryptedTitle = decryptedTitle; note.decryptedContent = decryptedContent; note.decryptedTitleCache = decryptedTitle;
                noteTitleDisplay.textContent = decryptedTitle;
                const searchTerm = searchNotesInput.value;
                const renderedHTML = marked.parse(decryptedContent);
                noteBodyDisplay.innerHTML = searchTerm ? renderedHTML.replace(new RegExp(searchTerm, 'gi'), match => `<mark>${match}</mark>`) : renderedHTML;
                noteContentDisplay.classList.remove('hidden'); selectNotePlaceholder.classList.add('hidden'); selectedNoteId = noteId;
                if (note.attempts > 0) { await setDoc(doc(db, 'users', currentUser.uid, 'notes', noteId), { attempts: 0 }, { merge: true }); }
                closeModal(decryptNoteModal); renderNotes(); startAutoLockTimer();
            } catch (error) {
                const attempts = (note.attempts || 0) + 1;
                if (attempts >= MAX_ATTEMPTS) { await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', noteId)); closeModal(decryptNoteModal); showToast('error', 'Note deleted due to too many failed attempts.'); } 
                else { await setDoc(doc(db, 'users', currentUser.uid, 'notes', noteId), { attempts }, { merge: true }); showToast('warning', `Incorrect password. ${MAX_ATTEMPTS - attempts} attempts left.`); el('attempts-warning').textContent = `Warning: ${MAX_ATTEMPTS - attempts} attempts remaining.`; }
            }
        });

        async function handleDeleteClick(e) {
            const noteId = e.target.dataset.id;
            const note = currentNotes.find(n => n.id === noteId); if (!note) return;
            try {
                const noteRef = doc(db, 'users', currentUser.uid, 'notes', noteId);
                const trashRef = doc(db, 'users', currentUser.uid, 'trash', noteId);
                const { decryptedTitle, decryptedContent, decryptedTitleCache, ...noteToTrash } = note;
                await setDoc(trashRef, { ...noteToTrash, trashedAt: Date.now() });
                await deleteDoc(noteRef);
                showToast('success', 'Note moved to trash.');
                if (selectedNoteId === noteId) clearNoteDisplay();
            } catch (error) {
                showToast('error', 'Failed to move note to trash.');
                console.error(error);
            }
        }

        deleteConfirmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const noteId = el('delete-confirm-note-id').value;
            const password = el('delete-confirm-password').value;
            const note = trashedNotes.find(n => n.id === noteId);
            if (!note) return;
            try {
                decrypt(note.title, password); // Verify password
                await deleteDoc(doc(db, 'users', currentUser.uid, 'trash', noteId));
                showToast('success', 'Note permanently deleted.');
            } catch (error) {
                showToast('error', 'Incorrect password. Deletion failed.');
            } finally {
                closeModal(deleteConfirmModal);
                renderTrashList(); // Re-render trash list
            }
        });

        async function handlePinClick(e) { const noteId = e.target.dataset.id; const note = currentNotes.find(n => n.id === noteId); if (!note) return; try { await setDoc(doc(db, 'users', currentUser.uid, 'notes', noteId), { pinned: !note.pinned }, { merge: true }); showToast('success', `Note ${!note.pinned ? 'pinned' : 'unpinned'}.`); } catch (error) { showToast('error', 'Failed to update pin status.'); } }
        
        copyNoteBtn.addEventListener('click', () => { navigator.clipboard.writeText(noteBodyDisplay.innerText).then(() => showToast('success', 'Note content copied!'), () => showToast('error', 'Failed to copy.')); });
        exportNoteBtn.addEventListener('click', () => { const title = noteTitleDisplay.textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase(); const content = noteBodyDisplay.innerText; const blob = new Blob([content], { type: 'text/plain' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${title || 'note'}.txt`; document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('success', 'Note exported!'); });
        printNoteBtn.addEventListener('click', () => { el('print-area').innerHTML = `<h1>${noteTitleDisplay.textContent}</h1><div class="prose prose-invert">${noteBodyDisplay.innerHTML}</div>`; window.print(); });

        const saveDraft = () => localStorage.setItem('noteDraft', JSON.stringify({ title: noteTitleInput.value, content: noteContentEditor.value, tags: noteTagsInput.value, color: selectedColor }));
        const getDraft = () => JSON.parse(localStorage.getItem('noteDraft')); const clearDraft = () => localStorage.removeItem('noteDraft');
        const updateCharCount = () => { const text = noteContentEditor.value; const charCount = text.length; const wordCount = text.trim().split(/\s+/).filter(Boolean).length; editorCharCount.textContent = `${charCount} characters, ${wordCount} words`; };

        const startAutoLockTimer = () => { stopAutoLockTimer(); autoLockTimer = setTimeout(() => { clearNoteDisplay(); showToast('warning', 'Note locked due to inactivity.'); }, AUTO_LOCK_TIME); };
        const stopAutoLockTimer = () => clearTimeout(autoLockTimer); const resetAutoLockTimer = () => { if(selectedNoteId) startAutoLockTimer(); };
        
        const checkPasswordStrength = (password) => { let score = 0; if (password.length > 8) score++; if (password.match(/[a-z]/)) score++; if (password.match(/[A-Z]/)) score++; if (password.match(/[0-9]/)) score++; if (password.match(/[^a-zA-Z0-9]/)) score++; strengthBar.classList.remove('strength-weak', 'strength-medium', 'strength-strong'); if (score <= 2) { strengthBar.style.width = '33%'; strengthBar.classList.add('strength-weak'); } else if (score <= 4) { strengthBar.style.width = '66%'; strengthBar.classList.add('strength-medium'); } else { strengthBar.style.width = '100%'; strengthBar.classList.add('strength-strong'); } };
        const updateTagFilter = () => { const tags = [...new Set(currentNotes.flatMap(n => n.tags || []))]; const currentVal = tagFilter.value; tagFilter.innerHTML = '<option value="">All Tags</option>'; tags.forEach(tag => tagFilter.innerHTML += `<option value="${tag}">${tag}</option>`); tagFilter.value = currentVal; };
        const updateColorPalette = (activeColor) => { selectedColor = activeColor; colorPalette.innerHTML = ''; NOTE_COLORS.forEach(color => { const swatch = document.createElement('div'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = color; if (color === activeColor) swatch.classList.add('selected'); swatch.onclick = () => updateColorPalette(color); colorPalette.appendChild(swatch); }); };

        let isTransitioning = false;
        const initialSetTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); el('theme-icon-sun').classList.toggle('hidden', theme === 'dark'); el('theme-icon-moon').classList.toggle('hidden', theme === 'light'); };
        const setTheme = (theme, e) => { if (isTransitioning) return; isTransitioning = true; const x = e.clientX; const y = e.clientY; const endRadius = Math.hypot(Math.max(x, window.innerWidth - x), Math.max(y, window.innerHeight - y)); const overlay = document.createElement('div'); overlay.className = 'theme-transition-overlay'; const targetBgColor = theme === 'dark' ? '#111827' : '#f9fafb'; overlay.style.backgroundColor = targetBgColor; overlay.style.setProperty('--x', `${x}px`); overlay.style.setProperty('--y', `${y}px`); document.body.appendChild(overlay); overlay.addEventListener('transitionend', () => { initialSetTheme(theme); overlay.remove(); isTransitioning = false; }, { once: true }); requestAnimationFrame(() => { overlay.style.clipPath = `circle(${endRadius}px at var(--x) var(--y))`; }); };
        themeToggleBtn.addEventListener('click', (e) => { const newTheme = (localStorage.getItem('theme') || 'dark') === 'dark' ? 'light' : 'dark'; setTheme(newTheme, e); });
        
        backupBtn.addEventListener('click', () => openModal(backupModal));
        el('export-form').addEventListener('submit', async (e) => { e.preventDefault(); const password = el('export-password').value; if (!password) { showToast('error', 'Backup password is required.'); return; } const allNotesSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'notes')); const allNotes = allNotesSnapshot.docs.map(d => ({id: d.id, ...d.data()})); const data = encrypt(JSON.stringify(allNotes), password); const blob = new Blob([data], { type: 'application/json' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `secure-notes-backup-${Date.now()}.json`; link.click(); showToast('success', 'Encrypted backup exported.'); });
        el('import-form').addEventListener('submit', (e) => { e.preventDefault(); const file = el('import-file').files[0]; const password = el('import-password').value; if (!file || !password) { showToast('error', 'File and password are required.'); return; } const reader = new FileReader(); reader.onload = async (event) => { try { const decrypted = decrypt(event.target.result, password); const notesToImport = JSON.parse(decrypted); const batch = writeBatch(db); for (const note of notesToImport) { const noteRef = doc(db, 'users', currentUser.uid, 'notes', note.id); batch.set(noteRef, note); } await batch.commit(); showToast('success', `${notesToImport.length} notes imported successfully.`); closeModal(backupModal); } catch (err) { showToast('error', 'Import failed. Check password or file.'); } }; reader.readAsText(file); });
        
        editorTabEdit.addEventListener('click', () => { noteContentEditor.classList.remove('hidden'); noteContentPreview.classList.add('hidden'); editorTabEdit.classList.add('active'); editorTabPreview.classList.remove('active'); });
        editorTabPreview.addEventListener('click', () => { noteContentEditor.classList.add('hidden'); noteContentPreview.classList.remove('hidden'); editorTabEdit.classList.remove('active'); editorTabPreview.classList.add('active'); noteContentPreview.innerHTML = marked.parse(noteContentEditor.value); });
        trashBtn.addEventListener('click', () => { renderTrashList(); openModal(trashModal); });

        shareNoteBtn.addEventListener('click', () => {
            const note = currentNotes.find(n => n.id === selectedNoteId);
            if (!note) return;
            const dataToShare = { title: note.title, content: note.content };
            const encryptedData = btoa(JSON.stringify(dataToShare));
            const shareLink = `${window.location.origin}${window.location.pathname}#share=${encryptedData}`;
            el('share-link-input').value = shareLink;
            openModal(shareModal);
        });
        el('copy-share-link-btn').addEventListener('click', () => { el('share-link-input').select(); document.execCommand('copy'); showToast('success', 'Share link copied!'); });

        function handleSharedNote(data) {
            el('app-container').classList.add('hidden');
            const shareContainer = el('share-view-container');
            shareContainer.classList.remove('hidden');
            shareContainer.innerHTML = `<div class="min-h-screen flex items-center justify-center p-4"><div class="modal-content w-full max-w-lg bg-dynamic-secondary text-dynamic-primary"><h2 class="text-2xl font-bold mb-4">Unlock Shared Note</h2><p class="text-sm text-dynamic-secondary mb-4">Enter the password to decrypt and view this note.</p><form id="unlock-share-form"><input id="share-password" type="password" placeholder="Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4" required><button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg">Unlock</button></form><div id="shared-note-content" class="hidden mt-6"></div></div></div>`;

            el('unlock-share-form').addEventListener('submit', (e) => {
                e.preventDefault();
                try {
                    const password = el('share-password').value;
                    const decodedData = JSON.parse(atob(data));
                    const decryptedTitle = decrypt(decodedData.title, password);
                    const decryptedContent = decrypt(decodedData.content, password);
                    const contentContainer = el('shared-note-content');
                    contentContainer.classList.remove('hidden');
                    contentContainer.innerHTML = `<h3 class="text-xl font-bold mb-4">${decryptedTitle}</h3><div class="prose prose-invert max-w-none">${marked.parse(decryptedContent)}</div>`;
                    el('unlock-share-form').classList.add('hidden');
                } catch (err) {
                    showToast('error', 'Incorrect password or corrupted data.');
                }
            });
        }
        
        function renderTrashList() {
            const trashListEl = el('trash-list');
            el('no-trash-msg').classList.toggle('hidden', trashedNotes.length > 0);
            trashListEl.innerHTML = '';
            trashedNotes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'p-4 bg-dynamic-tertiary rounded-lg flex justify-between items-center';
                noteEl.innerHTML = `<div><p>${note.decryptedTitleCache || `Note from ${new Date(parseInt(note.id)).toLocaleString()}`}</p><p class="text-xs text-gray-500">Trashed: ${new Date(note.trashedAt).toLocaleDateString()}</p></div><div class="flex gap-2"><button data-id="${note.id}" class="restore-btn text-green-500 hover:text-green-400">Restore</button><button data-id="${note.id}" class="perm-delete-btn text-red-500 hover:text-red-400">Delete</button></div>`;
                noteEl.querySelector('.restore-btn').addEventListener('click', async () => {
                    const { trashedAt, ...originalNote } = note;
                    await setDoc(doc(db, 'users', currentUser.uid, 'notes', note.id), originalNote);
                    await deleteDoc(doc(db, 'users', currentUser.uid, 'trash', note.id));
                    showToast('success', 'Note restored.');
                    renderTrashList();
                });
                noteEl.querySelector('.perm-delete-btn').addEventListener('click', () => {
                    deleteConfirmForm.reset();
                    el('delete-confirm-note-id').value = note.id;
                    el('delete-confirm-title').textContent = `Permanently Delete: ${note.decryptedTitleCache || `Note from ${new Date(parseInt(note.id)).toLocaleString()}`}`;
                    openModal(deleteConfirmModal);
                });
                trashListEl.appendChild(noteEl);
            });
        }

        passwordInput.addEventListener('input', (e) => checkPasswordStrength(e.target.value)); 
        [searchNotesInput, tagFilter].forEach(el => el.addEventListener('input', renderNotes));
        [noteTitleInput, noteTagsInput].forEach(el => el.addEventListener('input', saveDraft));
        noteContentEditor.addEventListener('input', () => { saveDraft(); updateCharCount(); });
        ['mousemove', 'mousedown', 'keydown', 'scroll'].forEach(event => window.addEventListener(event, resetAutoLockTimer));
        
        setInterval(() => { el('date-time').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }); }, 1000);
        initialSetTheme(localStorage.getItem('theme') || 'dark');
        
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.onclick = () => cancelBtnHandler(btn));
        document.querySelectorAll('.modal-overlay').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) { if (modal === noteFormModal) { clearDraft(); } closeModal(modal); } }); });
        
        handleAppLoad();
    </script>
</body>
</html>


