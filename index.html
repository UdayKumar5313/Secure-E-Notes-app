<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111827; 
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --accent-primary: #6d28d9; /* Deep Purple */
            --accent-secondary: #db2777; /* Fuchsia */
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
        }

        [data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .theme-transition-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            pointer-events: none;
            clip-path: circle(0% at var(--x) var(--y));
            transition: clip-path 1.2s cubic-bezier(0.65, 0, 0.35, 1);
        }
        
        .bg-dynamic-primary { background-color: var(--bg-primary); }
        .bg-dynamic-secondary { background-color: var(--bg-secondary); }
        .bg-dynamic-tertiary { background-color: var(--bg-tertiary); }
        .text-dynamic-primary { color: var(--text-primary); }
        .text-dynamic-secondary { color: var(--text-secondary); }
        .border-dynamic { border-color: var(--border-color); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .note-item.selected { background-color: var(--accent-primary) !important; color: white !important; }
        .note-item.pinned { border-left-color: #f59e0b !important; }
        
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); color: white; opacity: 0; transform: translateX(100%); transition: all 0.4s ease-in-out; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #059669; } .toast-error { background-color: #dc2626; } .toast-warning { background-color: #d97706; }

        #loader-overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 200; transition: opacity 0.3s ease; }
        .loader { width: 48px; height: 48px; border: 5px solid var(--text-primary); border-bottom-color: var(--accent-primary); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #password-strength-bar { height: 5px; width: 0%; border-radius: 5px; transition: width 0.3s ease, background-color 0.3s ease; }
        .strength-weak { background-color: #ef4444; } .strength-medium { background-color: #f59e0b; } .strength-strong { background-color: #10b981; }

        #note-content-editor { min-height: 8rem; border: 2px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem; background-color: var(--bg-tertiary); outline: none; }
        #note-content-editor:focus { border-color: var(--accent-primary); }
        .editor-toolbar button { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        
        .color-swatch { width: 24px; height: 24px; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: var(--accent-secondary); transform: scale(1.1); }
        .note-tag { background-color: var(--bg-tertiary); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; }

        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>

<body class="bg-dynamic-primary text-dynamic-primary">
    
    <div id="loader-overlay"><div class="loader"></div></div>
    <div id="toast-container"></div>
    <div id="print-area" class="hidden"></div>
    
    <div class="container mx-auto p-4 md:p-8">

        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-dynamic pb-6">
            <div>
                <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-pink-500">Secure E-Notes</h1>
                <p class="text-dynamic-secondary">Your encrypted notes, safely stored.</p>
            </div>
             <div class="flex items-center gap-4 mt-4 md:mt-0">
                <div id="date-time" class="text-lg font-semibold text-dynamic-secondary text-center md:text-right"></div>
                 <button id="theme-toggle" class="p-2 rounded-full hover:bg-dynamic-tertiary transition">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                 </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 flex flex-col gap-6">
                <button id="new-note-btn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    Create New Note
                </button>
                <div class="bg-dynamic-secondary p-6 rounded-2xl shadow-2xl flex-grow">
                    <h2 class="text-2xl font-semibold mb-4 text-dynamic-primary">Your Notes</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="search-notes" placeholder="Search notes..." class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-dynamic-primary">
                        <select id="tag-filter" class="bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-dynamic-primary"><option value="">All Tags</option></select>
                    </div>
                    <div id="notes-list" class="space-y-3 h-96 overflow-y-auto pr-2"></div>
                    <p id="no-notes-msg" class="text-gray-500 text-center mt-8 hidden">No notes found.</p>
                </div>
            </div>
            <div class="lg:col-span-2 bg-dynamic-secondary p-8 rounded-2xl shadow-2xl flex flex-col items-center justify-center min-h-[30rem]">
                <div id="note-content-display" class="w-full h-full hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4 gap-4">
                        <h2 id="note-title-display" class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400 truncate"></h2>
                        <div class="flex gap-2 shrink-0">
                            <button id="print-note-btn" title="Print Note" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h10a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg></button>
                            <button id="export-note-btn" title="Export as .txt" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                            <button id="copy-note-btn" title="Copy Content" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg></button>
                            <button id="edit-note-btn" title="Edit Note" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>
                    <div id="note-body-display" class="text-dynamic-secondary whitespace-pre-wrap bg-dynamic-primary p-6 rounded-lg flex-grow overflow-y-auto"></div>
                </div>
                <div id="select-note-placeholder" class="text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg><h3 class="text-2xl font-semibold">Select a Note</h3><p>Choose a note from the list to view its encrypted content.</p></div>
            </div>
        </main>
        <footer class="text-center text-gray-500 mt-8 pt-6 border-t border-dynamic">
            <p>Developed by <a href="https://www.linkedin.com/in/uday-kumar-cybersecurity?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" rel="noopener noreferrer" class="text-purple-400 hover:underline">Uday Kumar</a></p>
            <p id="user-id-display" class="text-xs mt-2 truncate"></p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="note-form-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary">
            <h2 id="note-form-title" class="text-2xl font-bold mb-6"></h2>
            <form id="note-form">
                <input type="hidden" id="note-id">
                <div class="mb-4">
                    <label for="note-title" class="block mb-2 font-semibold">Title</label>
                    <input type="text" id="note-title" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Content</label>
                    <div class="editor-toolbar mb-2 flex gap-2"><button type="button" data-command="bold" class="font-bold">B</button><button type="button" data-command="italic" class="italic">I</button><button type="button" data-command="underline" class="underline">U</button></div>
                    <div id="note-content-editor" contenteditable="true" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="note-tags" class="block mb-2 font-semibold">Tags (comma-separated)</label>
                        <input type="text" id="note-tags" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Color</label>
                        <div id="color-palette" class="flex gap-2 items-center"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <label for="note-password" class="block mb-2 font-semibold">Encryption Password</label>
                    <input type="password" id="note-password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500" required placeholder="Enter password to save">
                </div>
                <div class="mb-6"><div class="bg-gray-700 rounded-lg overflow-hidden"><div id="password-strength-bar"></div></div></div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="note-submit-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"></button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="decrypt-note-modal" class="modal-overlay">
        <div class="modal-content bg-dynamic-secondary text-dynamic-primary"><h2 class="text-2xl font-bold mb-2">Enter Password</h2><p id="decrypt-note-title" class="text-dynamic-secondary mb-4"></p><p id="attempts-warning" class="text-red-500 text-sm mb-4 h-5 font-semibold"></p><form id="decrypt-note-form"><input type="hidden" id="decrypt-note-id"><input type="password" id="decrypt-password" placeholder="Password" class="w-full bg-dynamic-tertiary border-2 border-dynamic rounded-lg py-2 px-4 mb-4 focus:outline-none focus:ring-2 focus:ring-purple-500" required><div class="flex justify-end gap-4"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-2 px-4 rounded-lg">Decrypt</button></div></form></div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content text-center bg-dynamic-secondary text-dynamic-primary"><h2 id="confirm-title" class="text-2xl font-bold mb-4">Are you sure?</h2><p id="confirm-message" class="mb-6 text-lg text-dynamic-secondary"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button><button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Delete</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBDzoObYxGLMhP8_-xkOsWp2fvXWYlWniY", authDomain: "adaptistudy.firebaseapp.com", projectId: "adaptistudy",
          storageBucket: "adaptistudy.appspot.com", messagingSenderId: "881929223792", appId: "1:881929223792:web:ccc93653fa969e3cfa3eb5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; let notesUnsubscribe = null; let currentNotes = []; let selectedNoteId = null; let selectedColor = null;
        const MAX_ATTEMPTS = 5; let autoLockTimer = null; const AUTO_LOCK_TIME = 3 * 60 * 1000;
        const NOTE_COLORS = ['#34d399', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899'];

        const el = (id) => document.getElementById(id);
        const loaderOverlay = el('loader-overlay');
        const showLoader = () => loaderOverlay.style.display = 'flex'; 
        const hideLoader = () => loaderOverlay.style.display = 'none';

        const newNoteBtn = el('new-note-btn'), notesListEl = el('notes-list'), noNotesMsg = el('no-notes-msg');
        const searchNotesInput = el('search-notes'), noteContentDisplay = el('note-content-display'), selectNotePlaceholder = el('select-note-placeholder');
        const noteTitleDisplay = el('note-title-display'), noteBodyDisplay = el('note-body-display'), themeToggleBtn = el('theme-toggle');
        const noteFormModal = el('note-form-modal'), decryptNoteModal = el('decrypt-note-modal'), confirmModal = el('confirm-modal');
        const noteForm = el('note-form'), decryptNoteForm = el('decrypt-note-form'), editNoteBtn = el('edit-note-btn'), copyNoteBtn = el('copy-note-btn');
        const exportNoteBtn = el('export-note-btn'), printNoteBtn = el('print-note-btn'), confirmOkBtn = el('confirm-ok-btn'), passwordInput = el('note-password');
        const strengthBar = el('password-strength-bar'), noteContentEditor = el('note-content-editor'), noteTitleInput = el('note-title');
        const tagFilter = el('tag-filter'), noteTagsInput = el('note-tags'), colorPalette = el('color-palette');

        const showToast = (type, message) => { const toast = document.createElement('div'); toast.className = `toast toast-${type}`; toast.textContent = message; el('toast-container').appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 5000); };
        const encrypt = (text, password) => CryptoJS.AES.encrypt(text, password).toString();
        const decrypt = (ciphertext, password) => { const bytes = CryptoJS.AES.decrypt(ciphertext, password); const decryptedText = bytes.toString(CryptoJS.enc.Utf8); if (!decryptedText) throw new Error("Decryption failed"); return decryptedText; };
        
        const openModal = (modal) => modal.classList.add('active'); const closeModal = (modal) => modal.classList.remove('active');
        const cancelBtnHandler = (btn) => { const modal = btn.closest('.modal-overlay'); if (modal === noteFormModal) { clearDraft(); } closeModal(modal); };
        
        onAuthStateChanged(auth, user => { if (user) { currentUser = user; el('user-id-display').textContent = `User ID: ${user.uid}`; loadNotes(); } else { signInAnonymously(auth).catch(err => { console.error(err); hideLoader(); }); } });
        function loadNotes() { if (!currentUser) return; const notesCollection = collection(db, 'users', currentUser.uid, 'notes'); if (notesUnsubscribe) notesUnsubscribe(); notesUnsubscribe = onSnapshot(notesCollection, (snapshot) => { currentNotes = snapshot.docs.map(doc => { const existing = currentNotes.find(n => n.id === doc.id); return { id: doc.id, ...doc.data(), decryptedTitleCache: existing?.decryptedTitleCache, decryptedContent: existing?.decryptedContent, decryptedTitle: existing?.decryptedTitle }; }); renderNotes(); hideLoader(); }, (err) => { console.error(err); hideLoader(); }); }
        
        function renderNotes() {
            const searchTerm = searchNotesInput.value.toLowerCase(); const selectedTag = tagFilter.value;
            const filteredNotes = currentNotes.filter(n => (n.decryptedTitleCache?.toLowerCase().includes(searchTerm) || new Date(parseInt(n.id)).toLocaleString().toLowerCase().includes(searchTerm)) && (!selectedTag || (n.tags && n.tags.includes(selectedTag))));
            notesListEl.innerHTML = ''; noNotesMsg.classList.toggle('hidden', currentNotes.length > 0);
            updateTagFilter();
            filteredNotes.sort((a, b) => (b.pinned || false) - (a.pinned || false) || b.id - a.id).forEach(note => {
                const noteEl = document.createElement('div');
                const color = note.color || 'transparent';
                noteEl.className = `note-item p-4 bg-dynamic-tertiary text-dynamic-secondary rounded-lg cursor-pointer border-l-4 hover:bg-gray-600 transition flex justify-between items-center`;
                noteEl.style.borderLeftColor = note.pinned ? '#f59e0b' : color;
                noteEl.dataset.id = note.id; noteEl.classList.toggle('selected', note.id === selectedNoteId);
                const titleText = note.decryptedTitleCache ? note.decryptedTitleCache : `Note - ${new Date(parseInt(note.id)).toLocaleString()}`;
                const tagsHTML = (note.tags || []).map(tag => `<span class="note-tag text-dynamic-secondary">${tag}</span>`).join(' ');
                noteEl.innerHTML = `
                    <div class="flex-grow overflow-hidden">
                        <p class="truncate" title="${titleText}">${titleText}</p>
                        <div class="flex gap-1 mt-1 flex-wrap">${tagsHTML}</div>
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                        <button data-id="${note.id}" title="Pin Note" class="pin-btn p-1 ${note.pinned ? 'text-yellow-400' : 'text-gray-500'} hover:text-yellow-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v1.063l5.243 5.242a1 1 0 01-.707 1.707H4.464a1 1 0 01-.707-1.707L9 5.063V4a1 1 0 011-1zM4.05 14a1 1 0 01.95.684l.5 2A1 1 0 006.452 18h7.096a1 1 0 00.951-1.316l.5-2a1 1 0 01.95-.684h0V14H4.05z" clip-rule="evenodd" /></svg></button>
                        <button data-id="${note.id}" title="Delete Note" class="delete-btn p-1 text-gray-500 hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                    </div>`;
                noteEl.addEventListener('click', (e) => { if (!e.target.closest('button')) handleNoteSelection(note.id); });
                noteEl.querySelector('.pin-btn').addEventListener('click', handlePinClick);
                noteEl.querySelector('.delete-btn').addEventListener('click', handleDeleteClick);
                notesListEl.appendChild(noteEl);
            });
        }
        
        function clearNoteDisplay() { selectedNoteId = null; noteContentDisplay.classList.add('hidden'); selectNotePlaceholder.classList.remove('hidden'); stopAutoLockTimer(); renderNotes(); }

        newNoteBtn.addEventListener('click', () => { const draft = getDraft(); if (draft) { el('confirm-title').textContent = 'Unsaved Draft'; el('confirm-message').textContent = 'You have an unsaved draft. Do you want to restore it?'; el('confirm-ok-btn').textContent = 'Restore'; openModal(confirmModal); confirmOkBtn.onclick = () => { openNoteForm(draft); closeModal(confirmModal); el('confirm-ok-btn').textContent = 'Delete'; }; el('confirm-cancel-btn').onclick = () => { clearDraft(); openNoteForm(); closeModal(confirmModal); el('confirm-ok-btn').textContent = 'Delete'; }; } else { openNoteForm(); } });
        function openNoteForm(data = {}) {
            noteForm.reset(); noteContentEditor.innerHTML = data.content || ''; noteTitleInput.value = data.title || '';
            noteTagsInput.value = (data.tags || []).join(', ');
            updateColorPalette(data.color || null);
            checkPasswordStrength(''); el('note-id').value = data.id || ''; const isEditing = !!data.id;
            el('note-form-title').textContent = isEditing ? 'Edit Note' : 'Create New Note';
            el('note-submit-btn').innerHTML = isEditing ? `Save Changes` : `Create & Encrypt`;
            openModal(noteFormModal);
        }

        editNoteBtn.addEventListener('click', () => { const note = currentNotes.find(n => n.id === selectedNoteId); if (!note || !note.decryptedTitle) return; openNoteForm({ id: note.id, title: note.decryptedTitle, content: note.decryptedContent, tags: note.tags, color: note.color }); });

        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const id = el('note-id').value; const title = noteTitleInput.value;
            const content = noteContentEditor.innerHTML; const password = passwordInput.value;
            const tags = noteTagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
            const isNew = !id; const noteRef = doc(db, 'users', currentUser.uid, 'notes', id || Date.now().toString());
            const existingNote = isNew ? {} : currentNotes.find(n => n.id === id);
            const noteData = { title: encrypt(title, password), content: encrypt(content, password), attempts: 0, pinned: existingNote?.pinned || false, tags: tags, color: selectedColor };
            try { await setDoc(noteRef, noteData, { merge: true }); showToast('success', `Note ${isNew ? 'created' : 'updated'}!`); clearDraft(); if (!isNew) clearNoteDisplay(); closeModal(noteFormModal); } 
            catch (error) { showToast('error', 'Failed to save note.'); console.error(error); }
        });

        function handleNoteSelection(noteId) { if (noteId === selectedNoteId) { showToast('warning', 'This note is already open.'); return; } const note = currentNotes.find(n => n.id === noteId); if (!note) return; decryptNoteForm.reset(); el('decrypt-note-id').value = noteId; el('decrypt-note-title').textContent = `Unlock: ${note.decryptedTitleCache || `Note from ${new Date(parseInt(note.id)).toLocaleString()}`}`; const attempts = note.attempts || 0; el('attempts-warning').textContent = attempts > 0 ? `Warning: ${MAX_ATTEMPTS - attempts} attempts remaining.` : ''; openModal(decryptNoteModal); }

        decryptNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const noteId = el('decrypt-note-id').value; const password = el('decrypt-password').value;
            let note = currentNotes.find(n => n.id === noteId); if (!note) return;
            try {
                const decryptedTitle = decrypt(note.title, password); const decryptedContent = decrypt(note.content, password);
                note.decryptedTitle = decryptedTitle; note.decryptedContent = decryptedContent; note.decryptedTitleCache = decryptedTitle;
                noteTitleDisplay.textContent = decryptedTitle; noteBodyDisplay.innerHTML = decryptedContent;
                noteContentDisplay.classList.remove('hidden'); selectNotePlaceholder.classList.add('hidden'); selectedNoteId = noteId;
                if (note.attempts > 0) { await setDoc(doc(db, 'users', currentUser.uid, 'notes', noteId), { attempts: 0 }, { merge: true }); }
                closeModal(decryptNoteModal); renderNotes(); startAutoLockTimer();
            } catch (error) {
                const attempts = (note.attempts || 0) + 1;
                if (attempts >= MAX_ATTEMPTS) { await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', noteId)); closeModal(decryptNoteModal); showToast('error', 'Note deleted due to too many failed attempts.'); } 
                else { await setDoc(doc(db, 'users', currentUser.uid, 'notes', noteId), { attempts }, { merge: true }); showToast('warning', `Incorrect password. ${MAX_ATTEMPTS - attempts} attempts left.`); el('attempts-warning').textContent = `Warning: ${MAX_ATTEMPTS - attempts} attempts remaining.`; }
            }
        });

        function handleDeleteClick(e) { const noteId = e.target.dataset.id; el('confirm-title').textContent = 'Delete Note'; el('confirm-message').textContent = 'This action cannot be undone. Are you sure?'; el('confirm-ok-btn').textContent = 'Delete'; openModal(confirmModal); confirmOkBtn.onclick = async () => { try { await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', noteId)); showToast('success', 'Note deleted.'); if (selectedNoteId === noteId) clearNoteDisplay(); } catch (error) { showToast('error', 'Failed to delete note.'); } finally { closeModal(confirmModal); } }; }
        async function handlePinClick(e) { const noteId = e.target.dataset.id; const note = currentNotes.find(n => n.id === noteId); if (!note) return; try { await setDoc(doc(db, 'users', currentUser.uid, 'notes', noteId), { pinned: !note.pinned }, { merge: true }); showToast('success', `Note ${!note.pinned ? 'pinned' : 'unpinned'}.`); } catch (error) { showToast('error', 'Failed to update pin status.'); } }
        
        copyNoteBtn.addEventListener('click', () => { navigator.clipboard.writeText(noteBodyDisplay.innerText).then(() => showToast('success', 'Note content copied!'), () => showToast('error', 'Failed to copy.')); });
        exportNoteBtn.addEventListener('click', () => { const title = noteTitleDisplay.textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase(); const content = noteBodyDisplay.innerText; const blob = new Blob([content], { type: 'text/plain' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${title || 'note'}.txt`; document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('success', 'Note exported!'); });
        printNoteBtn.addEventListener('click', () => { el('print-area').innerHTML = `<h1>${noteTitleDisplay.textContent}</h1><div>${noteBodyDisplay.innerHTML}</div>`; window.print(); });

        const saveDraft = () => localStorage.setItem('noteDraft', JSON.stringify({ title: noteTitleInput.value, content: noteContentEditor.innerHTML }));
        const getDraft = () => JSON.parse(localStorage.getItem('noteDraft')); const clearDraft = () => localStorage.removeItem('noteDraft');
        
        const startAutoLockTimer = () => { stopAutoLockTimer(); autoLockTimer = setTimeout(() => { clearNoteDisplay(); showToast('warning', 'Note locked due to inactivity.'); }, AUTO_LOCK_TIME); };
        const stopAutoLockTimer = () => clearTimeout(autoLockTimer); const resetAutoLockTimer = () => { if(selectedNoteId) startAutoLockTimer(); };
        
        const checkPasswordStrength = (password) => {
            let score = 0; if (password.length > 8) score++; if (password.match(/[a-z]/)) score++; if (password.match(/[A-Z]/)) score++;
            if (password.match(/[0-9]/)) score++; if (password.match(/[^a-zA-Z0-9]/)) score++;
            strengthBar.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
            if (score <= 2) { strengthBar.style.width = '33%'; strengthBar.classList.add('strength-weak'); } 
            else if (score <= 4) { strengthBar.style.width = '66%'; strengthBar.classList.add('strength-medium'); } 
            else { strengthBar.style.width = '100%'; strengthBar.classList.add('strength-strong'); }
        };

        const updateTagFilter = () => { const tags = [...new Set(currentNotes.flatMap(n => n.tags || []))]; const currentVal = tagFilter.value; tagFilter.innerHTML = '<option value="">All Tags</option>'; tags.forEach(tag => tagFilter.innerHTML += `<option value="${tag}">${tag}</option>`); tagFilter.value = currentVal; };
        const updateColorPalette = (activeColor) => { selectedColor = activeColor; colorPalette.innerHTML = ''; NOTE_COLORS.forEach(color => { const swatch = document.createElement('div'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = color; if (color === activeColor) swatch.classList.add('selected'); swatch.onclick = () => updateColorPalette(color); colorPalette.appendChild(swatch); }); };

        let isTransitioning = false;
        const initialSetTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            el('theme-icon-sun').classList.toggle('hidden', theme === 'dark');
            el('theme-icon-moon').classList.toggle('hidden', theme === 'light');
        };

        const setTheme = (theme, e) => {
            if (isTransitioning) return;
            isTransitioning = true;
            const x = e.clientX;
            const y = e.clientY;
            const endRadius = Math.hypot(Math.max(x, window.innerWidth - x), Math.max(y, window.innerHeight - y));
            const overlay = document.createElement('div');
            overlay.className = 'theme-transition-overlay';
            const targetBgColor = theme === 'dark' ? '#111827' : '#f9fafb';
            overlay.style.backgroundColor = targetBgColor;
            overlay.style.setProperty('--x', `${x}px`);
            overlay.style.setProperty('--y', `${y}px`);
            document.body.appendChild(overlay);
            overlay.addEventListener('transitionend', () => {
                initialSetTheme(theme);
                overlay.remove();
                isTransitioning = false;
            }, { once: true });
            requestAnimationFrame(() => {
                overlay.style.clipPath = `circle(${endRadius}px at var(--x) var(--y))`;
            });
        };
        
        themeToggleBtn.addEventListener('click', (e) => {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme, e);
        });

        document.querySelector('.editor-toolbar').addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON') document.execCommand(e.target.dataset.command, false, null); });
        passwordInput.addEventListener('input', (e) => checkPasswordStrength(e.target.value)); 
        [searchNotesInput, tagFilter].forEach(el => el.addEventListener('input', renderNotes));
        [noteTitleInput, noteContentEditor, noteTagsInput].forEach(el => el.addEventListener('input', saveDraft));
        ['mousemove', 'mousedown', 'keydown', 'scroll'].forEach(event => window.addEventListener(event, resetAutoLockTimer));
        
        setInterval(() => { el('date-time').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }, 1000);
        initialSetTheme(localStorage.getItem('theme') || 'dark');
        
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.onclick = () => cancelBtnHandler(btn));
        el('confirm-cancel-btn').onclick = () => closeModal(confirmModal);

        showLoader();
    </script>
</body>
</html>

